<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TatilKaptani.com - Kaptanınız Yanınızda</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-functions-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <a href="#" class="logo">TatilKaptani.com</a>
        <div class="user-actions">
            <div id="authButtons">
                <button id="loginBtn">Giriş Yap</button>
                <button id="registerBtn">Üye Ol</button>
            </div>
            <div id="loggedInUser" style="display: none;">
                <span id="usernameDisplay"></span>
                <button id="logoutBtn">Çıkış Yap</button>
            </div>
        </div>
    </header>

    <div id="appModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button id="modalConfirmBtn">Tamam</button>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Üye Girişi</h2>
            <input type="email" id="loginEmail" placeholder="E-posta Adresi" required>
            <input type="password" id="loginPassword" placeholder="Şifre" required>
            <button id="performLoginBtn">Giriş Yap</button>
            <p id="forgotPasswordLink">Şifremi Unuttum</p>
            <div id="loginMessage" class="modal-message"></div>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Üye Ol</h2>
            <input type="text" id="registerUsername" placeholder="Kullanıcı Adı" required>
            <input type="email" id="registerEmail" placeholder="E-posta Adresi" required>
            <input type="password" id="registerPassword" placeholder="Şifre" required>
            <button id="performRegisterBtn">Kayıt Ol</button>
            <div id="registerMessage" class="modal-message"></div>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Şifre Sıfırla</h2>
            <input type="email" id="resetEmail" placeholder="E-posta Adresiniz" required>
            <button id="performResetBtn">Şifre Sıfırlama Linki Gönder</button>
            <div id="resetMessage" class="modal-message"></div>
        </div>
    </div>

    <div class="main-layout">
        <div class="left-sidebar">
            <h2>Palmiye Kaptan</h2>
            <nav class="sidebar-nav">
                <ul>
                    <li><button data-section="chat-section" class="active"><i class="fas fa-comments"></i> Sohbet Asistanı</button></li>
                    <li><button data-section="game-section"><i class="fas fa-gamepad"></i> Tatil Avı (Oyun)</button></li>
                    <li><button data-section="virtual-holiday-section"><i class="fas fa-globe-americas"></i> Sanal Tatil Planı</button></li>
                    <li><button data-section="ai-photo-studio-section"><i class="fas fa-paint-brush"></i> AI Fotoğraf Stüdyosu</button></li>
                    <li><button data-section="vip-planner-section"><i class="fas fa-plane-departure"></i> VIP A'dan Z'ye Tur Planlayıcı</button></li>
                    <li><button data-section="user-info-section"><i class="fas fa-user-circle"></i> Üyelik Bilgileri</button></li>
                    <li><button data-section="time-travel-section"><i class="fas fa-hourglass-half"></i> Zamanda Yolculuk Tatili</button></li>
                    <li><button data-section="destiny-route-section"><i class="fas fa-crystal-ball"></i> Kader Rotası</button></li>
                    <li><button data-section="ai-companion-section"><i class="fas fa-robot"></i> AI Yoldaşım</button></li>
                    <li><button data-section="payment-section"><i class="fas fa-credit-card"></i> VIP Üyelik Al</button></li>
                    <li><button data-section="contact-us-section"><i class="fas fa-envelope"></i> Bize Ulaşın</button></li>
                </ul>
            </nav>
        </div>

        <div class="content-area">
            <div class="top-bar">
                <div class="info-group">
                    <span id="tatilpuan-top"><i class="fas fa-star"></i> TatilPuan: 0 (Bronz)</span>
                    <span id="user-id-display" style="font-size:0.8em; opacity:0.8;"></span>
                    <button id="voice-toggle-top"><i class="fas fa-volume-up"></i> Ses: Açık</button>
                    <select id="language-select" style="background-color: rgba(0, 77, 64, 0.8); color: white; border: none; padding: 5px; border-radius: 5px;">
                        <option value="tr">Türkçe</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <span id="slogan-top"></span>
            </div>

            <div id="chat-section" class="content-section active">
                <h2><i class="fas fa-comments"></i> Sohbet Asistanı</h2>
                <div id="chat-box" class="chat-messages" aria-live="polite" aria-label="Sohbet kutusu"></div>
                <div class="loading-indicator" id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Palmiye Kaptan düşünüyor...</div>
                <div class="input-group">
                    <input type="text" id="user-input-chat" placeholder="Bir tatil sorusu yazın..." />
                    <button id="send-button-chat" class="send-btn">Gönder</button>
                </div>
            </div>

            <div id="game-section" class="content-section">
                <h2><i class="fas fa-gamepad"></i> Tatil Avı (Mini Oyun)</h2>
                <div class="feature-section">
                    <h3>Palmiye Kaptan'ın Bilgi Yarışması!</h3>
                    <p>Sana 3 soru soracağım. Doğru cevaplarsan PalmCoin kazanacaksın!</p>
                    <button id="start-game-btn">Oyuna Başla</button>
                    <div id="game-output" style="margin-top: 20px;"></div>
                    <input type="text" id="game-answer-input" placeholder="Cevabınızı buraya yazın (A, B, C)..." style="display: none; width: calc(100% - 20px); padding: 10px; margin-top: 15px; border-radius: 5px;">
                    <button id="submit-game-answer-btn" style="display: none; margin-top: 10px;">Cevapla</button>
                </div>
            </div>

            <div id="virtual-holiday-section" class="content-section">
                <h2><i class="fas fa-globe-americas"></i> Sanal Tatil Planı</h2>
                <div class="feature-section">
                    <h3>Hayalinizdeki Sanal Tatili Yaratın!</h3>
                    <p>Tatile gidemeyenler için özel olarak tasarlandı! Nereye gitmek istersiniz ve kaç gün kalacaksınız?
                        Yapay zekamız sizin için o tatili canlı ve sürükleyici bir hikaye ile canlandıracak.</p>
                    <div class="feature-form">
                        <label for="virtual-city">Şehir / Yer:</label>
                        <input type="text" id="virtual-city" placeholder="Örn: Venedik" />
                        <label for="virtual-days">Gün Sayısı:</label>
                        <input type="number" id="virtual-days" placeholder="Örn: 5" min="1" />
                        <label for="virtual-duration-minutes">Sanal Tur Süresi (Dakika): <small>(<span id="virtual-tour-cost">50</span> PalmCoin)</small></label>
                        <input type="number" id="virtual-duration-minutes" placeholder="Örn: 10" min="1" value="5" />
                        <label for="virtual-activities">Sanal Tatilde Yapmak İstedikleriniz (Detaylı):</label>
                        <textarea id="virtual-activities" rows="3" placeholder="Örn: Yerel pazarları gezmek, tekne turuna çıkmak, tarihi yerleri ziyaret etmek..."></textarea>
                        <label for="virtual-image-prompt">Hediye Resim Açıklaması (Genel Sanal Tatil Teması):</label>
                        <textarea id="virtual-image-prompt" rows="2" placeholder="Örn: Gün batımında tropik plaj, palmiye ağaçları ve sakin deniz"></textarea>
                        <button id="start-virtual-btn">Sanal Tatili Oluştur</button>
                    </div>
                    <div class="loading-indicator" id="virtual-loading"><i class="fas fa-spinner fa-spin"></i> Sanal tatiliniz hazırlanıyor...</div>
                    <div id="virtual-holiday-output" class="plan-output" style="display: none;">
                        <h4 id="virtual-output-title"></h4>
                        <p id="virtual-output-story"></p>
                        <div id="virtual-images-container" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px;">
                        </div>
                        <button id="send-virtual-image-email-btn" style="margin-top: 15px; display: none;">Hediye Resmi E-postana Gönder (Demo)</button>
                    </div>
                </div>
            </div>

            <div id="ai-photo-studio-section" class="content-section">
                <h2><i class="fas fa-paint-brush"></i> AI Fotoğraf Stüdyosu</h2>
                <div class="feature-section" id="ai-photo-access-check">
                    <h3>Bu özellik sadece Altın üyelerimiz içindir!</h3>
                    <p>Hayalinizdeki görselleri yapay zeka ile gerçeğe dönüştürün! Tek yapmanız gereken, istediğiniz fotoğrafı metinle tanımlamak.</p>
                    <button id="go-to-ai-photo-payment-btn">Hemen Altın Üye Ol!</button>
                </div>
                <div id="ai-photo-form-area" style="display: none;">
                    <div class="feature-section">
                        <h3>Hayalindeki Fotoğrafı Oluştur (Altın Üye Özel)</h3>
                        <p>Ne tür bir fotoğraf istediğinizi detaylıca tanımlayın. Örneğin: "Gün batımında tropik bir adada palmiye ağaçları ve sakin bir deniz, gerçeküstü tarzda, yüksek çözünürlüklü".</p>
                        <div class="feature-form">
                            <label for="ai-photo-prompt">Fotoğraf Açıklaması:</label>
                            <textarea id="ai-photo-prompt" rows="4" placeholder="Örn: Sualtı şehrinde yüzen balıklar, fütüristik, parlak renkler..."></textarea>
                            <label for="ai-photo-style">Fotoğraf Stili:</label>
                            <select id="ai-photo-style">
                                <option value="realistic">Gerçekçi</option>
                                <option value="watercolor">Suluboya</option>
                                <option value="anime">Anime</option>
                                <option value="cyberpunk">Siberpunk</option>
                                <option value="fantasy">Fantastik</option>
                            </select>
                            <label for="ai-photo-count">Oluşturulacak Resim Sayısı (1-3):</label>
                            <input type="number" id="ai-photo-count" value="1" min="1" max="3" />
                            <button id="generate-ai-photo-btn">Fotoğrafı Oluştur</button>
                        </div>
                        <div class="loading-indicator" id="ai-photo-loading"><i class="fas fa-spinner fa-spin"></i> Fotoğrafınız oluşturuluyor...</div>
                        <div id="ai-photo-output" class="plan-output" style="display: none;">
                            <h4>Oluşturulan Fotoğraflarınız:</h4>
                            <div id="generated-images-container" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 15px;">
                            </div>
                            <button id="download-all-images-btn" style="margin-top: 15px; display: none;">Tümünü İndir (<span id="download-all-cost"></span> PalmCoin)</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="vip-planner-section" class="content-section">
                <h2><i class="fas fa-plane-departure"></i> VIP A'dan Z'ye Tur Planlayıcı</h2>
                <div class="feature-section" id="vip-access-check">
                    <h3>Bu özellik sadece Altın üyelerimiz içindir!</h3>
                    <p>Tam entegre tatil planlama hizmetimizle, uçuşlardan otellere, transferlerden kişiye özel rotalara kadar her şeyi yapay zekamız sizin için planlıyor.
                        Tatil stresini tamamen unutun, sadece anın tadını çıkarın!</p>
                    <button id="go-to-vip-payment-btn">Hemen Altın Üye Ol!</button>
                </div>
                <div id="vip-planner-form-area" style="display: none;">
                    <div class="feature-section">
                        <h3>A'dan Z'ye Tatil Planlama (Altın Üye Özel)</h3>
                        <p>Hayalinizdeki tatilin tüm detaylarını yapay zekamız sizin için ayarlasın! Otelinden uçağına, transferinden her gezisine kadar sanal yapay zeka ayarlayıp rota çizecek ve size gönderecek!</p>
                        <div class="feature-form">
                            <label for="vip-destination">Gidilecek Şehir/Ülke:</label>
                            <input type="text" id="vip-destination" placeholder="Örn: Tokyo" />
                            <label for="vip-duration">Kalış Süresi (Gün):</label>
                            <input type="number" id="vip-duration" placeholder="Örn: 7" min="1" />
                            <label for="vip-travelers">Kişi Sayısı:</label>
                            <input type="number" id="vip-travelers" placeholder="Örn: 2" min="1" />
                            <label for="vip-budget">Bütçe Seviyesi:</label>
                            <div class="budget-options">
                                <button data-budget="ekonomik">Ekonomik</button>
                                <button data-budget="orta">Orta</button>
                                <button data-budget="lüks">Lüks</button>
                            </div>
                            <label for="vip-type">Tatil Tipi:</label>
                            <select id="vip-type">
                                <option value="macera">Macera</option>
                                <option value="dinlenme">Dinlenme</option>
                                <option value="kültür">Kültür</option>
                                <option value="romantik">Romantik</option>
                                <option value="aile">Aile</option>
                                <option value="alisveris">Alışveriş</option>
                            </select>
                            <button id="generate-vip-plan-btn">VIP Planı Oluştur</button>
                        </div>
                        <div class="loading-indicator" id="vip-planner-loading"><i class="fas fa-spinner fa-spin"></i> VIP planınız hazırlanıyor...</div>
                        <div id="vip-plan-output" class="plan-output" style="display: none;"></div>
                        <div id="vip-plan-chat-area" style="margin-top: 20px; display: none;">
                            <h3>Plan Hakkında Soru Sor (<small>10 PalmCoin/Soru</small>)</h3>
                            <div id="vip-plan-chat-box" class="chat-messages" style="max-height: 200px;"></div>
                            <div class="input-group">
                                <input type="text" id="vip-plan-input" placeholder="Plan hakkında bir şeyler sorun..." />
                                <button id="send-vip-plan-message-btn" class="send-btn">Soru Sor</button>
                            </div>
                        </div>
                    </div>

                    <div class="feature-section" id="niche-vip-request-area">
                        <h3>Özel Niş Tur Planı (Altın Üye Özel)</h3>
                        <p>Alışılmışın dışında, tamamen size özel bir tur mu istiyorsunuz? Yapay zekamız, en niş ve özel isteklerinizi bile harika bir tatil planına dönüştürecek!</p>
                        <div class="feature-form">
                            <label for="niche-topic">Niş Konu/İlgi Alanı (Örn: Antik Kalıntıları Keşfetme, Uzay Turizmi Simülasyonu, Yemek Festivalleri):</label>
                            <input type="text" id="niche-topic" placeholder="Niş konu veya ilgi alanı" />
                            <label for="niche-details">Özel İstekleriniz/Detaylar (Örn: Az bilinen yerler, yerel etkileşimler, sürprizler...):</label>
                            <textarea id="niche-details" rows="3" placeholder="Ek detaylar..."></textarea>
                            <button id="generate-niche-plan-btn">Niş Planı Oluştur</button>
                        </div>
                        <div class="loading-indicator" id="niche-plan-loading"><i class="fas fa-spinner fa-spin"></i> Niş planınız hazırlanıyor...</div>
                        <div id="niche-plan-output" class="plan-output" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div id="user-info-section" class="content-section">
                <h2><i class="fas fa-user-circle"></i> Üyelik Bilgileri</h2>
                <div class="feature-section">
                    <h3>Kullanıcı Profili</h3>
                    <p>Kullanıcı ID'si: <strong id="display-userid">Yükleniyor...</strong></p>
                    <p>Adınız: <strong id="display-username">Misafir</strong></p>
                    <p>E-posta Adresiniz: <strong id="display-user-email">Ayarlanmadı</strong></p>
                    <button id="set-user-email-btn">E-posta Ayarla / Güncelle</button>
                    <p>Toplam TatilPuan: <strong id="display-tatilpuan">0</strong></p>
                    <p>Üyelik Seviyeniz: <strong id="display-membership-level">Bronz</strong></p>
                    <p>Kazandığınız PalmCoin: <strong id="display-game-score">0</strong></p>
                    <button id="update-username-btn">Kullanıcı Adı Belirle / Güncelle</button> </div>

                <div class="feature-section" id="palmcoin-history-section">
                    <h3>PalmCoin Geçmişi</h3>
                    <p>Son kazanılan/harcanan PalmCoin aktiviteleri:</p>
                    <ul id="palmcoin-history-list">
                        <li>Başlangıç: 0 PalmCoin</li>
                    </ul>
                </div>

                <div class="feature-section" id="admin-message-section">
                    <h3>Yönetici Mesajı Ayarları (Demo)</h3>
                    <p style="color: red;">Bu bir demo yönetim panelidir. Gerçek uygulamalarda güvenlik için arka uç gerektirir.</p>
                    <label for="admin-message-input">Yönetici Mesajı:</label>
                    <textarea id="admin-message-input" rows="3" placeholder="Yeni bir duyuru veya ilan yazın..."></textarea>
                    <button id="update-admin-message-btn">Mesajı Yayınla</button>
                    <div class="loading-indicator" id="admin-message-loading"><i class="fas fa-spinner fa-spin"></i> Mesaj güncelleniyor...</div>
                </div>

                <div class="feature-section">
                    <h3>Geçmiş Sorgular (Demo)</h3>
                    <ul id="past-queries-list">
                        <li>(Bu kısım için gerçek bir geçmiş kaydı Firebase'e eklenebilir)</li>
                        <li>Sanal tatil Paris 7 gün</li>
                        <li>Bana rota öner Fethiye 3 gün</li>
                        <li>Oyun</li>
                    </ul>
                </div>

                <div class="feature-section">
                    <h3>Rezervasyon Geçmişi (Demo)</h3>
                    <p>Henüz bir rezervasyon geçmişi bulunmamaktadır. VIP Tur Planlayıcı ile tatilinizi planlayın!</p>
                </div>
            </div>

            <div id="time-travel-section" class="content-section">
                <h2><i class="fas fa-hourglass-half"></i> Zamanda Yolculuk Tatili</h2>
                <div class="feature-section" id="time-travel-access-check">
                    <h3>Bu özellik Altın üyelerimize özeldir!</h3>
                    <p>Tarihin derinliklerinde veya geleceğin gizemlerinde unutulmaz bir yolculuğa çıkın. AI sizin için eşsiz bir zaman dilimi simülasyonu yaratacak.</p>
                    <button id="go-to-time-travel-payment-btn">Hemen Altın Üye Ol!</button>
                </div>
                <div id="time-travel-form-area" style="display: none;">
                    <div class="feature-section">
                        <h3>Zamanda Yolculuk Deneyimi (Altın Üye Özel)</h3>
                        <p>Nereye ve ne zaman gitmek istersiniz? AI size o dönemi canlandıracak!</p>
                        <div class="feature-form">
                            <label for="time-travel-era">Gitmek istediğiniz dönem (Yıl/Dönem):</label>
                            <input type="text" id="time-travel-era" placeholder="Örn: Antik Roma M.S. 79, 2077 Mars Kolonisi" />
                            <label for="time-travel-duration">Kalış Süresi (Gün):</label>
                            <input type="number" id="time-travel-duration" placeholder="Örn: 3" min="1" />
                            <label for="time-travel-character">Tanışmak istediğiniz hayali/tarihi karakter (Opsiyonel):</label>
                            <input type="text" id="time-travel-character" placeholder="Örn: Kleopatra, Bir robot mühendis" />
                            <label for="time-travel-focus">Odak noktası (Örn: Müzik, Yemek, Bilim, Savaş...):</label>
                            <input type="text" id="time-travel-focus" placeholder="Örn: Dönemin müzikleri, Geleceğin yemekleri" />
                            <button id="start-time-travel-btn">Zaman Yolculuğunu Başlat</button>
                        </div>
                        <div class="loading-indicator" id="time-travel-loading"><i class="fas fa-spinner fa-spin"></i> Zaman makinesi hazırlanıyor...</div>
                        <div id="time-travel-output" class="plan-output" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div id="destiny-route-section" class="content-section">
                <h2><i class="fas fa-crystal-ball"></i> Kader Rotası</h2>
                <div class="feature-section">
                    <h3>Palmiye Kaptan'ın Kehaneti!</h3>
                    <p>AI, gelecekteki rüya tatilinizi tahmin ediyor. Sadece birkaç bilgiye ihtiyacım var.</p>
                    <div class="feature-form">
                        <label for="destiny-age">Yaşınız:</label>
                        <input type="number" id="destiny-age" placeholder="Örn: 30" />
                        <label for="destiny-hobby">Hobilerinizden biri:</label>
                        <input type="text" id="destiny-hobby" placeholder="Örn: Doğa yürüyüşü, okumak" />
                        <label for="destiny-dream">Gelecekle ilgili bir hayaliniz:</label>
                        <input type="text" id="destiny-dream" placeholder="Örn: Dünyayı gezmek, kitap yazmak" />
                        <label for="destiny-color">En sevdiğiniz renk (Kehaneti kişiselleştirir):</label>
                        <input type="text" id="destiny-color" placeholder="Örn: Mavi" />
                        <button id="predict-destiny-btn">Kader Rotamı Öğren!</button>
                    </div>
                    <div class="loading-indicator" id="destiny-loading"><i class="fas fa-spinner fa-spin"></i> Kaderiniz yazılıyor...</div>
                    <div id="destiny-route-output" class="plan-output" style="display: none;"></div>
                    <button id="realize-destiny-btn" style="display: none; margin-top: 20px;">Kaderimi Gerçekleştir! (VIP)</button>
                </div>
            </div>

            <div id="ai-companion-section" class="content-section">
                <h2><i class="fas fa-robot"></i> AI Yoldaşım</h2>
                <div class="feature-section">
                    <h3>Kaptan Yardımcınızı Oluşturun!</h3>
                    <p>Tatilinizde size eşlik edecek kişisel bir yapay zeka arkadaşı. Ona bir isim verin ve kişiliğini seçin!</p>
                    <div class="feature-form">
                        <label for="companion-name">Yoldaşınızın Adı:</label>
                        <input type="text" id="companion-name" placeholder="Örn: Seyahatör" />
                        <label for="companion-personality">Kişiliği:</label>
                        <select id="companion-personality">
                            <option value="esprili">Esprili</option>
                            <option value="bilgili">Bilgili</option>
                            <option value="sakin">Sakin</option>
                            <option value="maceraperest">Maceraperest</option>
                            <option value="ilham-veren">İlham Veren</option>
                        </select>
                        <button id="create-companion-btn">Yoldaşımı Oluştur</button>
                    </div>
                    <div id="companion-chat-area" style="margin-top: 20px; display: none;">
                        <h3><span id="active-companion-name"></span> ile Sohbet</h3>
                        <div id="companion-chat-box" class="chat-messages" style="max-height: 200px;"></div>
                        <div class="input-group">
                            <input type="text" id="companion-input" placeholder="Yoldaşınıza bir şeyler sorun..." />
                            <button id="send-companion-message-btn" class="send-btn">Mesaj Gönder</button>
                        </div>
                    </div>
                    <div class="loading-indicator" id="companion-loading"><i class="fas fa-spinner fa-spin"></i> Yoldaşınız yükleniyor...</div>
                </div>
            </div>

            <div id="payment-section" class="content-section">
                <h2><i class="fas fa-credit-card"></i> VIP Üyelik Al</h2>
                <div class="feature-section">
                    <h3>Altın Üyelik: Sınırları Aşan Tatil Deneyimi!</h3>
                    <p>Aylık sadece **99.99 TL** ile:</p>
                    <ul>
                        <li><i class="fas fa-check-circle" style="color: green;"></i> Kişiye Özel A'dan Z'ye Tur Planlama (Uçuş, Otel, Transfer, Günlük Rota)</li>
                        <li><i class="fas fa-check-circle" style="color: green;"></i> Zamanda Yolculuk Tatilleri</li>
                        <li><i class="fas fa-check-circle" style="color: green;"></i> Kişisel AI Yoldaşınız</li>
                        <li><i class="fas fa-check-circle" style="color: green;"></i> Reklamsız Deneyim</li>
                        <li><i class="fas fa-check-circle" style="color: green;"></i> Özel Müşteri Desteği</li>
                        <li><i class="fas fa-check-circle" style="color: green;"></i> Niş Tur Planlama</li>
                    </ul>
                    <div class="feature-form">
                        <h3>Ödeme Bilgileri (Demo)</h3>
                        <p style="color: red;">Bu bir demo ödeme ekranıdır, gerçek bir işlem yapılmayacaktır.</p>
                        <label for="card-number">Kart Numarası:</label>
                        <input type="text" id="card-number" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" />
                        <div class="card-input-group">
                            <div>
                                <label for="expiry-date">Son Kullanma Tarihi (AA/YY):</label>
                                <input type="text" id="expiry-date" placeholder="AA/YY" maxlength="5" />
                            </div>
                            <div>
                                <label for="cvv">CVV:</label>
                                <input type="text" id="cvv" placeholder="XXX" maxlength="4" />
                            </div>
                        </div>
                        <label for="card-holder-name">Kart Sahibinin Adı:</label>
                        <input type="text" id="card-holder-name" placeholder="Ad Soyad" />
                        <button id="complete-payment-btn">Ödemeyi Tamamla (Demo)</button>
                    </div>
                </div>
            </div>

            <div id="contact-us-section" class="content-section">
                <h2><i class="fas fa-envelope"></i> Bize Ulaşın</h2>
                <div class="feature-section">
                    <h3>Sorularınız veya Destek Talepleriniz İçin</h3>
                    <p>Her türlü soru, öneri veya destek talebiniz için bize yazmaktan çekinmeyin. Ekibimiz en kısa sürede size geri dönecektir.</p>
                    <div class="feature-form">
                        <label for="contact-subject">Konu:</label>
                        <input type="text" id="contact-subject" placeholder="Örn: VIP üyelik hakkında soru" />
                        <label for="contact-email">E-posta Adresiniz:</label>
                        <input type="email" id="contact-email" placeholder="Örn: adiniz@ornek.com" />
                        <label for="contact-message">Mesajınız:</label>
                        <textarea id="contact-message" rows="5" placeholder="Detaylı mesajınızı buraya yazın..."></textarea>
                        <label for="contact-file">Dosya Ekle (Opsiyonel):</label>
                        <input type="file" id="contact-file" />
                        <button id="send-contact-form-btn">Gönder</button>
                    </div>
                    <div class="loading-indicator" id="contact-loading"><i class="fas fa-spinner fa-spin"></i> Mesajınız gönderiliyor...</div>
                </div>
            </div>
        </div>

        <div class="right-sidebar">
            <div class="admin-ad-message" id="admin-display-message">
                <h4>Yönetici Mesajı</h4>
                <p>Yükleniyor...</p>
            </div>
            <div id="dynamic-ads-container">
                <a href="https://www.booking.com/index.tr.html" target="_blank" class="ad-area-dynamic">
                    <img src="https://images.unsplash.com/photo-1542312389-9828d5427d14?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Booking.com Reklamı - Otel Rezervasyonu">
                    <p>Milyonlarca otelde en iyi fiyatlar!</p>
                </a>
                <a href="https://www.skyscanner.com.tr/" target="_blank" class="ad-area-dynamic">
                    <img src="https://images.unsplash.com/photo-1595015093557-0105342a3d07?q=80&w=1932&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Skyscanner Reklamı - Uçak Bileti">
                    <p>Ucuz uçak bileti mi arıyorsunuz?</p>
                </a>
                <a href="https://www.getyourguide.com/tr/" target="_blank" class="ad-area-dynamic">
                    <img src="https://images.unsplash.com/photo-1628172922129-c1d0637b7891?q=80&w=1932&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="GetYourGuide Reklamı - Turlar ve Aktiviteler">
                    <p>Yerel turlar ve aktiviteler keşfet!</p>
                </a>
                <a href="https://www.tripadvisor.com.tr/" target="_blank" class="ad-area-dynamic">
                    <img src="https://images.unsplash.com/photo-1517457210959-fc3d97f37472?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="TripAdvisor Reklamı - Gezgin Yorumları">
                    <p>Milyonlarca gezginin yorumlarını oku!</p>
                </a>
                <a href="https://www.rentalcars.com/" target="_blank" class="ad-area-dynamic">
                    <img src="https://images.unsplash.com/photo-1549488344-f8510a26569f?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Rentalcars Reklamı - Araç Kiralama">
                    <p>Tatilinize uygun araç kiralayın!</p>
                </a>
                <div class="ad-area-dynamic" style="background-color: #e0f7fa; border-color: #00bcd4; color: #00796b;">
                    <i class="fas fa-bullhorn" style="font-size: 2em; margin-bottom: 10px; color: #0097a7;"></i>
                    <p>Burada sizin ilanınız olabilir! <br>İlan vermek için bize e-posta gönderin.</p>
                    <a href="mailto:info@tatilkaptani.com" style="color: #00796b; font-weight: bold;">info@tatilkaptani.com</a>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; <span id="currentYear"></span> TatilKaptani.com - Tüm Hakları Saklıdır.</p>
    </footer>

    <script>
        // Firebase SDK v9.6.10 uyumlu versiyonlar için Firebase modüllerini doğrudan kullanın.

        // ##### DİKKAT: ÜRETİM ORTAMINDA BU ANAHTARLARI KESİNLİKLE ARKA UCA TAŞIYIN! #####
        // API Anahtarları ve Sabitler
        // const OPENROUTER_API_KEY = "YOUR_OPENROUTER_API_KEY"; // ARTIK SCRIPT.JS (CLOUD FUNCTION) TARAFINDA OLACAK
        // const GOOGLE_GEMINI_API_KEY = "YOUR_GOOGLE_GEMINI_API_KEY"; // ARTIK SCRIPT.JS (CLOUD FUNCTION) TARAFINDA OLACAK

        const IMAGE_DOWNLOAD_COST_PER_IMAGE = 50;
        const VIRTUAL_TOUR_COST_PER_MINUTE = 10;
        const VIP_PLAN_CHAT_COST = 10;

        // Firebase yapılandırması - KENDİ BİLGİLERİNİZİ GİRİN!
        const firebaseConfig = {
            apiKey: "AIzaSyD3jHygqHg-ibg6LhmsvU5OpxHEGjtdFrw", // DEĞİŞTİRİN
            authDomain: "tatil-b8a56.firebaseapp.com", // DEĞİŞTİRİN
            projectId: "tatil-b8a56", // DEĞİŞTİRİN
            storageBucket: "tatil-b8a56.firebasestorage.app", // DEĞİŞTİRİN
            messagingSenderId: "YO529113216844", // DEĞİŞTİRİN
            appId: "1:529113216844:web:8f4c3ba0fd5cf1801e01e9" // DEĞİŞTİRİN
        };

        // Firebase'i başlat
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const functions = firebase.functions(); // Cloud Functions SDK'sını başlat

        // Global Değişkenler (DOM'a referans verenler, başlangıçta null veya boş olarak tanımlanır)
        let currentUserId = null;
        let voiceEnabled = true;
        let tatilPuan = 0;
        let userMembershipLevel = "Bronz";
        let userName = "Misafir";
        let userEmail = "Ayarlanmadı";
        let gameActive = false;
        let currentQuestionIndex = 0;
        let gameScore = 0;
        let currentGeneratedImages = [];
        let generatedVirtualImageUrl = '';
        let currentVipPlan = "";
        let palmCoinHistory = [];
        let chatHistory = [];
        let aiCompanion = null;
        let companionChatHistory = [];
        let currentGameQuestion = null;
        let selectedBudget = "";

        // DOM Element Referanslarını Global Olarak Bildir (ancak değer ataması DOM hazır olunca yapılacak)
        let loginBtn, registerBtn, logoutBtn, authButtons, loggedInUserSection, usernameDisplay;
        let chatBox, chatInput, sendChatBtn, chatLoading, tatilpuanTop, sloganTop, voiceToggleTop, languageSelect, userIdDisplay, sidebarButtons, contentSections;
        let appModal, modalTitle, modalMessage, modalConfirmBtn;
        let loginModal, registerModal, forgotPasswordModal, loginEmailInput, loginPasswordInput, performLoginBtn, loginMessage, registerUsernameInput, registerEmailInput, registerPasswordInput, performRegisterBtn, registerMessage, resetEmailInput, performResetBtn, resetMessage, forgotPasswordLink, closeButtons;
        let startGameBtn, gameOutput, gameAnswerInput, submitGameAnswerBtn;
        let virtualCityInput, virtualDaysInput, virtualDurationMinutesInput, virtualActivitiesInput, virtualImagePromptInput, virtualTourCostEl, startVirtualBtn, virtualHolidayOutput, virtualOutputTitle, virtualOutputStory, virtualImagesContainer, sendVirtualImageEmailBtn, virtualLoading;
        let aiPhotoAccessCheck, goToAiPhotoPaymentBtn, aiPhotoFormArea, aiPhotoPromptInput, aiPhotoStyleSelect, aiPhotoCountInput, generateAiPhotoButton, aiPhotoLoading, aiPhotoOutput, generatedImagesContainer, downloadAllImagesBtn, downloadAllCostSpan;
        let vipAccessCheck, goToVipPaymentBtn, vipPlannerFormArea, vipDestinationInput, vipDurationInput, vipTravelersInput, vipBudgetButtons, vipTypeSelect, generateVipPlanBtn, vipPlannerLoading, vipPlanOutput, vipPlanChatArea, vipPlanChatBox, vipPlanInput, sendVipPlanMessageBtn;
        let nicheTopicInput, nicheDetailsTextarea, generateNichePlanBtn, nichePlanLoading, nichePlanOutput;
        let displayUserId, displayUsername, displayUserEmail, setuserEmailBtn, displayTatilpuan, displayMembershipLevel, displayGameScore, updateUsernameBtn, palmCoinHistoryList;
        let adminMessageInput, updateAdminMessageBtn, adminMessageLoading, adminDisplayMessageEl;
        let timeTravelAccessCheck, goToTimeTravelPaymentBtn, timeTravelFormArea, timeTravelEraInput, timeTravelDurationInput, timeTravelCharacterInput, timeTravelFocusInput, startTimeTravelBtn, timeTravelLoading, timeTravelOutput;
        let destinyAgeInput, destinyHobbyInput, destinyDreamInput, destinyColorInput, predictDestinyBtn, destinyLoading, destinyRouteOutput, realizeDestinyBtn;
        let companionNameInput, companionPersonalitySelect, createCompanionBtn, companionChatArea, activeCompanionName, companionChatBox, companionInput, sendCompanionMessageBtn, companionLoading;
        let cardNumberInput, expiryDateInput, cvvInput, cardHolderNameInput, completePaymentBtn;
        let contactSubjectInput, contactEmailInput, contactMessageInput, contactFileInput, sendContactFormBtn, contactLoading;


        const sloganList = [
            "Hayalindeki tatili Palmiye Kaptan'la keşfet!",
            "Yapay zekâyla tatilin haritasını çiz!",
            "Palmiye Kaptan seni maceraya çağırıyor!",
            "TatilPuan kazan, üyelik seviyeni yükselt!",
            "Sanal ya da gerçek, her tatil özel!",
            "Yeni rotalar, yeni maceralar Palmiye Kaptan'la başlar!"
        ];
        let currentSloganIndex = 0;


        // --- Uygulama Başlangıcı ve Genel Fonksiyonlar ---
        // Bu fonksiyonlar, DOM elementlerine doğrudan erişmeden önce çağrılmamalıdır.
        window.initializeAppFeatures = function() {
            // Slogan başlatma
            updateSlogan();
            // Sayfa yüklendiğinde varsayılan olarak "Sohbet Asistanı" bölümünü göster
            window.showSection("chat-section");
        };

        // Modalları gizlemek için yardımcı fonksiyon
        function hideModal(modalElement) {
            if (modalElement) {
                modalElement.style.display = "none";
            }
        }
        window.hideModal = hideModal;

        // --- Firebase Kullanıcı Verileri Fonksiyonları ---
        window.getUserProfileRef = function() {
            if (!firestore || !currentUserId) {
                console.warn("Firestore veya Kullanıcı ID'si hazır değil. Profil referansı alınamıyor.");
                return null;
            }
            return firestore.collection('users').doc(currentUserId);
        };

        window.loadUserProfile = async function() {
            const profileRef = window.getUserProfileRef();
            if (!profileRef) {
                console.log("Profil referansı mevcut değil, varsayılan bilgiler gösteriliyor.");
                window.displayMembershipInfo();
                window.updateTatilPuanDisplay();
                if (userIdDisplay) userIdDisplay.textContent = `UID: ${currentUserId || 'Misafir'}`;
                return;
            }

            // Real-time güncellemeler için onSnapshot kullan
            profileRef.onSnapshot((docSnap) => {
                if (docSnap.exists) {
                    const data = docSnap.data();
                    userName = data.username || auth.currentUser.displayName || "Misafir";
                    tatilPuan = data.tatilPuanlari || 0;
                    userMembershipLevel = data.membershipLevel || "Bronz";
                    gameScore = data.gameScore || 0;
                    userEmail = data.email || auth.currentUser.email || "Ayarlanmadı";
                    palmCoinHistory = data.palmCoinHistory || [{ timestamp: new Date().toISOString(), type: "Başlangıç", amount: 0, current: 0 }];
                    console.log("Kullanıcı profili Firestore'dan yüklendi:", data);
                } else {
                    console.log("Kullanıcı profili bulunamadı, varsayılan oluşturuluyor.");
                    // Profil yoksa varsayılan profil oluştur. Bu ideal olarak kullanıcı kaydında gerçekleşmeli.
                    window.updateUserProfile({
                        username: auth.currentUser.displayName || auth.currentUser.email,
                        email: auth.currentUser.email,
                        tatilPuanlari: 0,
                        membershipLevel: "Bronz",
                        gameScore: 0,
                        palmCoinHistory: [{ timestamp: new Date().toISOString(), type: "Başlangıç", amount: 0, current: 0 }]
                    });
                }
                window.displayMembershipInfo();
                window.updateTatilPuanDisplay();
                window.updatePalmCoinHistoryDisplay();
                if (userIdDisplay) userIdDisplay.textContent = `UID: ${currentUserId || 'Misafir'}`;
            }, (error) => {
                console.error("Kullanıcı profili yüklenirken hata:", error);
                window.showModal("Hata", `Kullanıcı verileri yüklenirken bir sorun oluştu: ${error.message}.`);
            });
        };

        window.updateUserProfile = async function(dataToUpdate) {
            const profileRef = window.getUserProfileRef();
            if (!profileRef) {
                console.error("Profil referansı mevcut değil, güncelleme yapılamıyor.");
                return;
            }
            try {
                await profileRef.set(dataToUpdate, { merge: true });
                console.log("Kullanıcı profili güncellendi:", dataToUpdate);
            } catch (error) {
                console.error("Kullanıcı profili güncellenirken hata:", error);
                window.showModal("Hata", `Kullanıcı verileri kaydedilirken bir sorun oluştu: ${error.message}.`);
            }
        };

        // --- Firebase İlan ve Yönetici Mesajı Yönetimi Fonksiyonları ---
        window.getAdsCollectionRef = function() {
            if (!firestore) {
                console.error("Firestore hazır değil.");
                return null;
            }
            // Ortak erişilebilir bir koleksiyon için yol
            return firestore.collection('public').doc('data').collection('ads');
        };

        window.getAdminMessageRef = function() {
            if (!firestore) {
                console.error("Firestore hazır değil.");
                return null;
            }
            // Ortak erişilebilir bir belge için yol
            return firestore.collection('public').doc('data').collection('admin').doc("message");
        };

        window.loadAds = async function() {
            const adsCollectionRef = window.getAdsCollectionRef();
            if (!adsCollectionRef) {
                console.log("Reklam koleksiyonu referansı mevcut değil.");
                return;
            }
            /*
            try {
                const snapshot = await adsCollectionRef.get();
                const ads = snapshot.docs.map(doc => doc.data());
                const dynamicAdsContainer = document.getElementById('dynamic-ads-container');
                if (dynamicAdsContainer) {
                    dynamicAdsContainer.innerHTML = '';
                    ads.forEach(ad => {
                        const adElement = document.createElement('a');
                        adElement.href = ad.url;
                        adElement.target = '_blank';
                        adElement.classList.add('ad-area-dynamic');
                        adElement.innerHTML = `<img src="${ad.imageUrl}" alt="${ad.title}"><p>${ad.text}</p>`;
                        dynamicAdsContainer.appendChild(adElement);
                    });
                }
            } catch (error) {
                console.error("Dinamik reklamlar yüklenirken hata:", error);
            }
            */
        };

        window.loadAdminMessage = async function() {
            const adminMessageRef = window.getAdminMessageRef();
            if (!adminMessageRef) {
                console.log("Yönetici mesajı referansı mevcut değil.");
                if (adminDisplayMessageEl && adminDisplayMessageEl.querySelector('p')) {
                    adminDisplayMessageEl.querySelector('p').textContent = "Yönetici mesajı yüklenemedi: Veri hazır değil.";
                }
                return;
            }

            adminMessageRef.onSnapshot((docSnap) => {
                if (adminDisplayMessageEl) {
                    const adminDisplayMessageP = adminDisplayMessageEl.querySelector('p');
                    if (adminDisplayMessageP) {
                        if (docSnap.exists && docSnap.data().message) {
                            adminDisplayMessageP.textContent = docSnap.data().message;
                        } else {
                            adminDisplayMessageP.textContent = "Yönetici mesajı bulunmamaktadır.";
                        }
                    }
                }
            }, (error) => {
                console.error("Yönetici mesajı yüklenirken hata:", error);
                if (adminDisplayMessageEl && adminDisplayMessageEl.querySelector('p')) {
                    let errorMessage = `Yönetici mesajı yüklenemedi: ${error.message}.`;
                    if (error.code === 'permission-denied') {
                        errorMessage += " Lütfen Firebase güvenlik kurallarınızı kontrol edin (public/data/admin okuma izni).";
                    }
                    adminDisplayMessageEl.querySelector('p').textContent = errorMessage;
                }
            });
        };

        window.updateAdminMessage = async function(message) {
            const updateAdminMessageCallable = firebase.functions().httpsCallable('updateAdminMessage');
            if (adminMessageLoadingEl) adminMessageLoadingEl.style.display = 'block';
            try {
                const result = await updateAdminMessageCallable({ message: message });
                console.log("Yönetici mesajı başarıyla güncellendi (Cloud Function):", result.data);
                window.showModal("Başarılı", result.data.message);
            } catch (error) {
                console.error("Yönetici mesajı güncellenirken Cloud Function hatası:", error);
                let errorMessage = `Yönetici mesajı güncellenirken bir sorun oluştu: ${error.message}.`;
                if (error.code === 'permission-denied') {
                    errorMessage += " Yetkiniz olmayabilir veya güvenlik kuralları engelliyor olabilir.";
                } else if (error.code === 'unauthenticated') {
                    errorMessage += " Bu işlemi gerçekleştirmek için giriş yapmalısınız.";
                }
                window.showModal("Hata", errorMessage);
            } finally {
                if (adminMessageLoadingEl) adminMessageLoadingEl.style.display = 'none';
            }
        };

        // --- Genel UI ve Yardımcı Fonksiyonlar ---
        window.showModal = function(title, message) {
            if (!appModal || !modalTitle || !modalMessage || !modalConfirmBtn) {
                console.error("Modal elementleri bulunamadı. Modal gösterilemiyor.");
                return Promise.resolve(false);
            }

            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            appModal.style.display = "flex";

            const oldConfirmListener = modalConfirmBtn._eventListener;
            if (oldConfirmListener) {
                modalConfirmBtn.removeEventListener("click", oldConfirmListener);
            }

            return new Promise((resolve) => {
                const handleConfirm = () => {
                    appModal.style.display = "none";
                    modalConfirmBtn.removeEventListener("click", handleConfirm);
                    modalConfirmBtn._eventListener = null;
                    resolve(true);
                };
                modalConfirmBtn.addEventListener("click", handleConfirm);
                modalConfirmBtn._eventListener = handleConfirm;
            });
        };

        window.displayMessage = function(sender, text, chatBoxElement) { // chatBoxElement parametresi eklendi
            if (!chatBoxElement) {
                console.error("Sohbet kutusu elementi bulunamadı.");
                return;
            }
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", sender);
            const span = document.createElement('span');
            span.textContent = text;
            messageDiv.appendChild(span);
            chatBoxElement.appendChild(messageDiv);
            chatBoxElement.scrollTop = chatBoxElement.scrollHeight;
        };

        window.speak = function(text) {
            if (!languageSelect || !voiceEnabled || !window.speechSynthesis) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = languageSelect.value + "-" + languageSelect.value.toUpperCase();
            speechSynthesis.speak(utterance);
        };

        window.updateTatilPuan = async function(points, activity = "Genel Aktivite") {
            tatilPuan += points;
            palmCoinHistory.push({
                timestamp: new Date().toISOString(),
                type: points > 0 ? "Kazanıldı" : "Harcandı",
                activity: activity,
                amount: Math.abs(points),
                current: tatilPuan
            });

            if (palmCoinHistory.length > 20) {
                palmCoinHistory = palmCoinHistory.slice(palmCoinHistory.length - 20);
            }

            const oldLevel = userMembershipLevel;
            if (tatilPuan < 100) {
                userMembershipLevel = "Bronz";
            } else if (tatilPuan < 200) {
                userMembershipLevel = "Gümüş";
            } else {
                userMembershipLevel = "Altın";
            }

            if (currentUserId) {
                await window.updateUserProfile({
                    tatilPuanlari: tatilPuan,
                    membershipLevel: userMembershipLevel,
                    palmCoinHistory: palmCoinHistory,
                    gameScore: gameScore
                });
            }

            if (oldLevel !== userMembershipLevel) {
                window.showModal("Tebrikler!", `Üyelik seviyeniz **${userMembershipLevel}** seviyesine yükseldi! Yeni özelliklere göz atın.`);
                window.speak(`Tebrikler! Üyelik seviyeniz ${userMembershipLevel} seviyesine yükseldi!`);
            }
            window.updatePalmCoinHistoryDisplay();
            window.updateTatilPuanDisplay();
        };

        window.updateTatilPuanDisplay = function() {
            if (tatilpuanTop) {
                tatilpuanTop.innerHTML = `<i class="fas fa-star"></i> TatilPuan: ${tatilPuan} (${userMembershipLevel})`;
            }
            if (displayTatilpuan) displayTatilpuan.textContent = tatilPuan;
            if (displayMembershipLevel) displayMembershipLevel.textContent = userMembershipLevel;
        };

        window.displayMembershipInfo = function() {
            if (displayUserId) displayUserId.textContent = currentUserId || "Yükleniyor...";
            if (displayUsername) displayUsername.textContent = userName;
            if (displayUserEmail) displayUserEmail.textContent = userEmail;
            if (displayTatilpuan) displayTatilpuan.textContent = tatilPuan;
            if (displayMembershipLevel) displayMembershipLevel.textContent = userMembershipLevel;
            if (displayGameScore) displayGameScore.textContent = gameScore;
            if (userIdDisplay) userIdDisplay.textContent = `UID: ${currentUserId || 'Misafir'}`;
        };

        window.updatePalmCoinHistoryDisplay = function() {
            if (!palmCoinHistoryList) return;
            palmCoinHistoryList.innerHTML = '';
            palmCoinHistory.slice().reverse().forEach(entry => {
                const listItem = document.createElement("li");
                const date = new Date(entry.timestamp).toLocaleString();
                let color = '#333';
                if (entry.type === "Kazanıldı") {
                    color = 'green';
                } else if (entry.type === "Harcandı") {
                    color = 'red';
                }
                listItem.innerHTML = `<span style="color:${color};"><strong>${entry.type}:</strong> ${entry.amount} PalmCoin</span> - ${entry.activity} (${date}) - Toplam: ${entry.current}`;
                palmCoinHistoryList.appendChild(listItem);
            });
        };

        window.showSection = function(sectionId) {
            contentSections.forEach(section => {
                section.classList.remove("active");
                section.style.display = "none";
            });

            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add("active");
                activeSection.style.display = "flex";
            }

            sidebarButtons.forEach(button => button.classList.remove("active"));
            const activeButton = document.querySelector(`.sidebar-nav button[data-section='${sectionId}']`);
            if (activeButton) {
                activeButton.classList.add("active");
            }

            if (sectionId === "vip-planner-section") {
                window.checkVipAccess(aiPhotoAccessCheck, vipPlannerFormArea, "Altın"); // Kontrol edilecek
                window.checkVipAccess(aiPhotoAccessCheck, nicheVipRequestArea, "Altın"); // Kontrol edilecek
                if (vipPlanChatArea) vipPlanChatArea.style.display = 'none';
                if (vipPlanOutput) vipPlanOutput.style.display = 'none';
                currentVipPlan = "";
            } else if (sectionId === "time-travel-section") {
                window.checkVipAccess(timeTravelAccessCheck, timeTravelFormArea, "Altın");
            } else if (sectionId === "ai-photo-studio-section") {
                window.checkVipAccess(aiPhotoAccessCheck, aiPhotoFormArea, "Altın");
                if (generatedImagesContainer) generatedImagesContainer.innerHTML = '';
                if (downloadAllImagesBtn) downloadAllImagesBtn.style.display = 'none';
                if (aiPhotoOutput) aiPhotoOutput.style.display = 'none';
                currentGeneratedImages = [];
            } else if (sectionId === "user-info-section") {
                window.displayMembershipInfo();
                window.loadAdminMessage();
                window.updatePalmCoinHistoryDisplay();
            } else if (sectionId === "payment-section") {
                if (cardNumberInput) cardNumberInput.value = '';
                if (expiryDateInput) expiryDateInput.value = '';
                if (cvvInput) cvvInput.value = '';
                if (cardHolderNameInput) cardHolderNameInput.value = '';
            } else if (sectionId === "virtual-holiday-section") {
                if (virtualDurationMinutesInput && virtualTourCostEl) {
                    virtualTourCostEl.textContent = (parseInt(virtualDurationMinutesInput.value) * VIRTUAL_TOUR_COST_PER_MINUTE);
                }
                if (virtualHolidayOutput) virtualHolidayOutput.style.display = "none";
                if (virtualImagesContainer) virtualImagesContainer.innerHTML = '';
                if (sendVirtualImageEmailBtn) sendVirtualImageEmailBtn.style.display = 'none';
                generatedVirtualImageUrl = '';
            } else if (sectionId === "destiny-route-section") {
                if (destinyRouteOutput) destinyRouteOutput.style.display = "none";
                if (realizeDestinyBtn) realizeDestinyBtn.style.display = "none";
            }
            if (sectionId === "contact-us-section") {
                if (contactSubjectInput) contactSubjectInput.value = '';
                if (contactEmailInput) contactEmailInput.value = userEmail !== "Ayarlanmadı" ? userEmail : '';
                if (contactMessageInput) contactMessageInput.value = '';
                if (contactFileInput) contactFileInput.value = '';
            }
        };

        window.checkVipAccess = function(accessCheckEl, formAreaEl, requiredLevel) {
            const levels = ["Bronz", "Gümüş", "Altın"];
            const currentUserLevelIndex = levels.indexOf(userMembershipLevel);
            const requiredLevelIndex = levels.indexOf(requiredLevel);

            if (currentUserLevelIndex >= requiredLevelIndex) {
                if (accessCheckEl) accessCheckEl.style.display = "none";
                if (formAreaEl) formAreaEl.style.display = "block";
            } else {
                if (accessCheckEl) accessCheckEl.style.display = "block";
                if (formAreaEl) formAreaEl.style.display = "none";
            }
        };

        window.callOpenRouterAI = async function(prompt, model = "openai/gpt-3.5-turbo", loadingIndicator = null, currentChatHistory = []) {
            if (loadingIndicator) loadingIndicator.style.display = "block";

            try {
                const callAI = firebase.functions().httpsCallable('callOpenRouterAI');
                const result = await callAI({ prompt: prompt, model: model, chatHistory: currentChatHistory });
                return result.data.reply;
            } catch (error) {
                console.error("OpenRouter AI Cevap Hatası (Cloud Function):", error);
                window.showModal("AI Hatası!", `Bir AI hatası oluştu: ${error.message}. Lütfen API anahtarınızı, internet bağlantınızı veya Cloud Functions ayarlarınızı kontrol edin.`);
                return `Bir hata oluştu: ${error.message}`;
            } finally {
                if (loadingIndicator) loadingIndicator.style.display = "none";
            }
        };

        window.callImageGenerationAI = async function(promptText, loadingIndicator = null) {
            if (loadingIndicator) loadingIndicator.style.display = "block";

            try {
                const callImageAI = firebase.functions().httpsCallable('callImageGenerationAI');
                const result = await callImageAI({ promptText: promptText });
                return result.data.imageUrl;
            } catch (error) {
                console.error("Gemini Görsel Oluşturma AI Hatası (Cloud Function):", error);
                window.showModal("Görsel Oluşturma Hatası!", `Görsel oluşturulurken bir sorun oluştu: ${error.message}.`);
                return null;
            } finally {
                if (loadingIndicator) loadingIndicator.style.display = "none";
            }
        };

        // --- Slogan Güncelleme ---
        // Slogan listesi zaten tanımlı.
        function updateSlogan() {
            if (sloganTop) { // sloganTop'ın tanımlı olduğundan emin ol
                sloganTop.textContent = sloganList[currentSloganIndex];
            }
            currentSloganIndex = (currentSloganIndex + 1) % sloganList.length;
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            // TÜM DOM ELEMENTLERİNE BURADA DEĞER ATAMASI YAPILIR
            loginBtn = document.getElementById('loginBtn');
            registerBtn = document.getElementById('registerBtn');
            logoutBtn = document.getElementById('logoutBtn');
            authButtons = document.getElementById('authButtons');
            loggedInUserSection = document.getElementById('loggedInUser');
            usernameDisplay = document.getElementById('usernameDisplay');

            chatBox = document.getElementById("chat-box");
            chatInput = document.getElementById("user-input-chat");
            sendChatBtn = document.getElementById("send-button-chat");
            chatLoading = document.getElementById("chat-loading");
            tatilpuanTop = document.getElementById("tatilpuan-top");
            sloganTop = document.getElementById("slogan-top");
            voiceToggleTop = document.getElementById("voice-toggle-top");
            languageSelect = document.getElementById("language-select");
            userIdDisplay = document.getElementById("user-id-display");
            sidebarButtons = document.querySelectorAll(".sidebar-nav button");
            contentSections = document.querySelectorAll(".content-section");

            appModal = document.getElementById("appModal");
            modalTitle = document.getElementById("modalTitle");
            modalMessage = document.getElementById("modalMessage");
            modalConfirmBtn = document.getElementById("modalConfirmBtn");

            loginModal = document.getElementById('loginModal');
            registerModal = document.getElementById('registerModal');
            forgotPasswordModal = document.getElementById('forgotPasswordModal');
            loginEmailInput = document.getElementById('loginEmail');
            loginPasswordInput = document.getElementById('loginPassword');
            performLoginBtn = document.getElementById('performLoginBtn');
            loginMessage = document.getElementById('loginMessage');
            registerUsernameInput = document.getElementById('registerUsername');
            registerEmailInput = document.getElementById('registerEmail');
            registerPasswordInput = document.getElementById('registerPassword');
            performRegisterBtn = document.getElementById('performRegisterBtn');
            registerMessage = document.getElementById('registerMessage');
            resetEmailInput = document.getElementById('resetEmail');
            performResetBtn = document.getElementById('performResetBtn');
            resetMessage = document.getElementById('resetMessage');
            forgotPasswordLink = document.getElementById('forgotPasswordLink');
            closeButtons = document.querySelectorAll('.close-button');

            startGameBtn = document.getElementById("start-game-btn");
            gameOutput = document.getElementById("game-output");
            gameAnswerInput = document.getElementById("game-answer-input");
            submitGameAnswerBtn = document.getElementById("submit-game-answer-btn");

            virtualCityInput = document.getElementById("virtual-city");
            virtualDaysInput = document.getElementById("virtual-days");
            virtualDurationMinutesInput = document.getElementById("virtual-duration-minutes");
            virtualActivitiesInput = document.getElementById("virtual-activities");
            virtualImagePromptInput = document.getElementById("virtual-image-prompt");
            virtualTourCostEl = document.getElementById("virtual-tour-cost");
            startVirtualBtn = document.getElementById("start-virtual-btn");
            virtualHolidayOutput = document.getElementById("virtual-holiday-output");
            virtualOutputTitle = document.getElementById("virtual-output-title");
            virtualOutputStory = document.getElementById("virtual-output-story");
            virtualImagesContainer = document.getElementById("virtual-images-container");
            sendVirtualImageEmailBtn = document.getElementById("send-virtual-image-email-btn");
            virtualLoading = document.getElementById("virtual-loading");

            aiPhotoAccessCheck = document.getElementById("ai-photo-access-check");
            goToAiPhotoPaymentBtn = document.getElementById("go-to-ai-photo-payment-btn");
            aiPhotoFormArea = document.getElementById("ai-photo-form-area");
            aiPhotoPromptInput = document.getElementById("ai-photo-prompt");
            aiPhotoStyleSelect = document.getElementById("ai-photo-style");
            aiPhotoCountInput = document.getElementById("ai-photo-count");
            generateAiPhotoButton = document.getElementById("generate-ai-photo-btn");
            aiPhotoLoading = document.getElementById("ai-photo-loading");
            aiPhotoOutput = document.getElementById("ai-photo-output");
            generatedImagesContainer = document.getElementById("generated-images-container");
            downloadAllImagesBtn = document.getElementById("download-all-images-btn");
            downloadAllCostSpan = document.getElementById("download-all-cost");

            vipAccessCheck = document.getElementById("vip-access-check");
            goToVipPaymentBtn = document.getElementById("go-to-vip-payment-btn");
            vipPlannerFormArea = document.getElementById("vip-planner-form-area");
            vipDestinationInput = document.getElementById("vip-destination");
            vipDurationInput = document.getElementById("vip-duration");
            vipTravelersInput = document.getElementById("vip-travelers");
            vipBudgetButtons = document.querySelectorAll("#vip-planner-section .budget-options button");
            vipTypeSelect = document.getElementById("vip-type");
            generateVipPlanBtn = document.getElementById("generate-vip-plan-btn");
            vipPlannerLoading = document.getElementById("vip-planner-loading");
            vipPlanOutput = document.getElementById("vip-plan-output");
            vipPlanChatArea = document.getElementById("vip-plan-chat-area");
            vipPlanChatBox = document.getElementById("vip-plan-chat-box");
            vipPlanInput = document.getElementById("vip-plan-input");
            sendVipPlanMessageBtn = document.getElementById("send-vip-plan-message-btn");

            nicheTopicInput = document.getElementById("niche-topic");
            nicheDetailsTextarea = document.getElementById("niche-details");
            generateNichePlanBtn = document.getElementById("generate-niche-plan-btn");
            nichePlanLoading = document.getElementById("niche-plan-loading");
            nichePlanOutput = document.getElementById("niche-plan-output");

            displayUserId = document.getElementById("display-userid");
            displayUsername = document.getElementById("display-username");
            displayUserEmail = document.getElementById("display-user-email");
            setuserEmailBtn = document.getElementById("set-user-email-btn");
            displayTatilpuan = document.getElementById("display-tatilpuan");
            displayMembershipLevel = document.getElementById("display-membership-level");
            displayGameScore = document.getElementById("display-game-score");
            updateUsernameBtn = document.getElementById("update-username-btn");
            palmCoinHistoryList = document.getElementById("palmcoin-history-list");

            adminMessageInput = document.getElementById("admin-message-input");
            updateAdminMessageBtn = document.getElementById("update-admin-message-btn");
            adminMessageLoading = document.getElementById("admin-message-loading");
            adminDisplayMessageEl = document.getElementById("admin-display-message");

            timeTravelAccessCheck = document.getElementById("time-travel-access-check");
            goToTimeTravelPaymentBtn = document.getElementById("go-to-time-travel-payment-btn");
            timeTravelFormArea = document.getElementById("time-travel-form-area");
            timeTravelEraInput = document.getElementById("time-travel-era");
            timeTravelDurationInput = document.getElementById("time-travel-duration");
            timeTravelCharacterInput = document.getElementById("time-travel-character");
            timeTravelFocusInput = document.getElementById("time-travel-focus");
            startTimeTravelBtn = document.getElementById("start-time-travel-btn");
            timeTravelLoading = document.getElementById("time-travel-loading");
            timeTravelOutput = document.getElementById("time-travel-output");

            destinyAgeInput = document.getElementById("destiny-age");
            destinyHobbyInput = document.getElementById("destiny-hobby");
            destinyDreamInput = document.getElementById("destiny-dream");
            destinyColorInput = document.getElementById("destiny-color");
            predictDestinyBtn = document.getElementById("predict-destiny-btn");
            destinyLoading = document.getElementById("destiny-loading");
            destinyRouteOutput = document.getElementById("destiny-route-output");
            realizeDestinyBtn = document.getElementById("realize-destiny-btn");

            companionNameInput = document.getElementById("companion-name");
            companionPersonalitySelect = document.getElementById("companion-personality");
            createCompanionBtn = document.getElementById("create-companion-btn");
            companionChatArea = document.getElementById("companion-chat-area");
            activeCompanionName = document.getElementById("active-companion-name");
            companionChatBox = document.getElementById("companion-chat-box");
            companionInput = document.getElementById("companion-input");
            sendCompanionMessageBtn = document.getElementById("send-companion-message-btn");
            companionLoading = document.getElementById("companion-loading");

            cardNumberInput = document.getElementById("card-number");
            expiryDateInput = document.getElementById("expiry-date");
            cvvInput = document.getElementById("cvv");
            cardHolderNameInput = document.getElementById("card-holder-name");
            completePaymentBtn = document.getElementById("complete-payment-btn");

            contactSubjectInput = document.getElementById('contact-subject');
            contactEmailInput = document.getElementById('contact-email');
            contactMessageInput = document.getElementById('contact-message');
            contactFileInput = document.getElementById('contact-file');
            sendContactFormBtn = document.getElementById('send-contact-form-btn');
            contactLoading = document.getElementById('contact-loading');


            // Buradan itibaren uygulama başlatma ve olay dinleyicileri kodunuz devam eder
            window.initializeAppFeatures();

            sidebarButtons.forEach(button => {
                button.addEventListener("click", () => {
                    const sectionId = button.dataset.section;
                    window.showSection(sectionId);
                });
            });

            // Main chat assistant
            sendChatBtn.onclick = async () => {
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;

                window.displayMessage("user", userMessage, chatBox);
                chatHistory.push({ role: "user", content: userMessage }); // Kullanıcı mesajını geçmişe ekle
                chatInput.value = "";

                const selectedLanguage = languageSelect.value;
                const languagePrompt = selectedLanguage === 'tr' ? '(Türkçe)' : '(English)';

                const promptForAI = `You are a helpful travel assistant called "Palmiye Kaptan". User's message: "${userMessage}".
                                    Detect the language of the message (${languagePrompt}) and respond in that language.
                                    Provide creative, informative, and personalized assistance on topics like travel, destinations, accommodation, activities, budget planning, virtual tours, historical sites, and cultural experiences.
                                    Avoid repetitive or generic answers. Understand the context by considering previous messages in the chat history.
                                    If the user's message clearly indicates a feature request (e.g., 'I want to play a game', 'plan a trip', 'generate an image', 'I want to be VIP', 'set email', 'set admin message'),
                                    add a hidden tag at the end of your response in the format "[YÖNLENDİR: [section-name]]".
                                    Example: "Elbette, size özel bir tatil planı oluşturabilirim! [YÖNLENDİR: vip-planner-section]".
                                    Section names: game-section, virtual-holiday-section, ai-photo-studio-section, vip-planner-section, user-info-section, time-travel-section, destiny-route-section, ai-companion-section, payment-section, contact-us-section.
                                    Your response should be friendly and engaging.`;

                // AI çağrısı için geçmişi dilimle (bağlamı korumak ama çok uzun istekleri önlemek için)
                const chatHistoryForAI = chatHistory.slice(Math.max(chatHistory.length - 10, 0)); // Son 10 mesaj bağlam için

                const reply = await window.callOpenRouterAI(promptForAI, "openai/gpt-3.5-turbo", chatLoading, chatHistoryForAI);
                const redirectMatch = reply.match(/\[YÖNLENDİR:\s*([^\]]+)\]/);
                let cleanReply = reply.replace(/\[YÖNLENDİR:\s*([^\]]+)\]/, '').trim();

                window.displayMessage("ai", cleanReply, chatBox);
                chatHistory.push({ role: "assistant", content: cleanReply }); // AI yanıtını geçmişe ekle
                window.speak(cleanReply);
                window.updateTatilPuan(5, "Sohbet");

                if (currentUserId) {
                    // Sohbet geçmişini Firestore'a kaydet
                    try {
                        await firestore.collection('users').doc(currentUserId).collection('chatHistory').add({
                            userMessage: userMessage,
                            aiReply: cleanReply,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (e) {
                        console.error("Sohbet geçmişi Firestore'a kaydedilirken hata:", e);
                    }
                }

                if (redirectMatch && redirectMatch[1]) {
                    const targetSectionId = redirectMatch[1].trim();
                    const sectionNameMap = {
                        "game-section": "Tatil Avı (Oyun)",
                        "virtual-holiday-section": "Sanal Tatil Planı",
                        "ai-photo-studio-section": "AI Fotoğraf Stüdyosu",
                        "vip-planner-section": "VIP A'dan Z'ye Tur Planlayıcı",
                        "user-info-section": "Üyelik Bilgileri",
                        "time-travel-section": "Zamanda Yolculuk Tatili",
                        "destiny-route-section": "Kader Rotası",
                        "ai-companion-section": "AI Yoldaşım",
                        "payment-section": "VIP Üyelik Al",
                        "contact-us-section": "Bize Ulaşın"
                    };
                    const friendlySectionName = sectionNameMap[targetSectionId] || targetSectionId;

                    // Yönlendirme seçeneği ile modal göster
                    window.showModal(
                        "Yönlendirme Önerisi",
                        `Palmiye Kaptan, sanırım **${friendlySectionName}** bölümüyle ilgileniyorsunuz. Oraya gitmek ister misiniz?` +
                        `<br><br><button id="confirmRedirectBtn" style="background-color:#00796b; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">Evet, Git!</button>` +
                        `<button id="cancelRedirectBtn" style="background-color:#ccc; color:#333; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left: 10px;">Hayır, Burada Kal</button>`
                    );

                    // Modal içindeki dinamik butonlara olay dinleyicileri ekle
                    const confirmRedirectBtn = document.getElementById("confirmRedirectBtn");
                    const cancelRedirectBtn = document.getElementById("cancelRedirectBtn");

                    if (confirmRedirectBtn) {
                        confirmRedirectBtn.onclick = () => {
                            window.showSection(targetSectionId);
                            hideModal(appModal); // Uygulama modalını kapat
                        };
                    }
                    if (cancelRedirectBtn) {
                        cancelRedirectBtn.onclick = () => {
                            hideModal(appModal); // Uygulama modalını kapat
                        };
                    }
                }
            };

            chatInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendChatBtn.click();
            });

            // Ses kontrolü
            voiceToggleTop.onclick = () => {
                const newState = !voiceEnabled;
                voiceEnabled = newState;
                voiceToggleTop.innerHTML = voiceEnabled ? '<i class="fas fa-volume-up"></i> Ses: Açık' : '<i class="fas fa-volume-mute"></i> Ses: Kapalı';
                if (voiceEnabled) {
                    window.speak("Sesli yanıtlar açıldı.");
                } else {
                    if (window.speechSynthesis && window.speechSynthesis.speaking) {
                        window.speechSynthesis.cancel();
                    }
                }
            };

            languageSelect.addEventListener("change", () => {
                window.showModal("Dil Değişikliği", `Dil ${languageSelect.options[languageSelect.selectedIndex].text} olarak ayarlandı. AI bu dilde yanıt vermeye çalışacak.`);
                window.speak(`Language changed to ${languageSelect.options[languageSelect.selectedIndex].text}.`);
            });

            modalConfirmBtn.addEventListener("click", () => hideModal(appModal));

            // Giriş/Kayıt Modal butonları
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    hideModal(registerModal);
                    hideModal(forgotPasswordModal);
                    if (loginModal) loginModal.style.display = 'flex';
                });
            }
            if (registerBtn) {
                registerBtn.addEventListener('click', () => {
                    hideModal(loginModal);
                    hideModal(forgotPasswordModal);
                    if (registerModal) registerModal.style.display = 'flex';
                });
            }

            // Şifremi unuttum linki
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', () => {
                    hideModal(loginModal);
                    if (forgotPasswordModal) forgotPasswordModal.style.display = 'flex';
                });
            }

            // Tüm kapatma butonları için olay dinleyici
            closeButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    hideModal(event.target.closest('.modal'));
                });
            });

            // Modal dışına tıklayınca kapatma
            window.addEventListener('click', (event) => {
                if (event.target == loginModal) hideModal(loginModal);
                if (event.target == registerModal) hideModal(registerModal);
                if (event.target == forgotPasswordModal) hideModal(forgotPasswordModal);
                if (event.target == appModal) hideModal(appModal);
            });

            // Kayıt İşlemi
            performRegisterBtn.addEventListener('click', async () => {
                const username = registerUsernameInput.value.trim();
                const email = registerEmailInput.value.trim();
                const password = registerPasswordInput.value.trim();

                if (!username || !email || !password) {
                    registerMessage.textContent = 'Lütfen tüm alanları doldurun.';
                    registerMessage.style.color = 'red';
                    return;
                }
                if (password.length < 6) {
                    registerMessage.textContent = 'Şifre en az 6 karakter olmalıdır.';
                    registerMessage.style.color = 'red';
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: username });

                    // Kullanıcı verilerini Firestore'a kaydet
                    await firestore.collection('users').doc(userCredential.user.uid).set({
                        username: username,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        tatilPuanlari: 0,
                        membershipLevel: 'Bronz',
                        gameScore: 0,
                        palmCoinHistory: [{ timestamp: new Date().toISOString(), type: "Başlangıç", amount: 0, current: 0 }]
                    });

                    registerMessage.textContent = 'Kayıt başarılı! Hoş geldiniz. Şimdi giriş yapabilirsiniz.';
                    registerMessage.style.color = 'green';
                    try {
                        const sendWelcomeEmailCallable = firebase.functions().httpsCallable('sendWelcomeEmail');
                        await sendWelcomeEmailCallable({ email: email, username: username });
                        console.log("Hoş geldin e-postası Cloud Function tarafından çağrıldı.");
                    } catch (e) {
                        console.error("Hoş geldin e-postası Cloud Function çağrılırken hata:", e);
                    }

                    setTimeout(() => {
                        hideModal(registerModal);
                        if (loginModal) loginModal.style.display = 'flex';
                        if (loginEmailInput) loginEmailInput.value = email;
                    }, 2000);
                } catch (error) {
                    let errorMessage = 'Kayıt sırasında bir hata oluştu.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Bu e-posta adresi zaten kullanımda.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Şifre en az 6 karakter olmalıdır.';
                    } else {
                        errorMessage = error.message;
                    }
                    registerMessage.textContent = errorMessage;
                    registerMessage.style.color = 'red';
                    console.error('Kayıt hatası:', error);
                }
            });

            // Giriş İşlemi
            performLoginBtn.addEventListener('click', async () => {
                const email = loginEmailInput.value.trim();
                const password = loginPasswordInput.value.trim();

                if (!email || !password) {
                    loginMessage.textContent = 'Lütfen e-posta ve şifrenizi girin.';
                    loginMessage.style.color = 'red';
                    return;
                }

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    loginMessage.textContent = 'Giriş başarılı! Yönlendiriliyorsunuz...';
                    loginMessage.style.color = 'green';
                    setTimeout(() => {
                        hideModal(loginModal);
                    }, 1500);
                } catch (error) {
                    let errorMessage = 'Giriş başarısız. Lütfen bilgilerinizi kontrol edin.';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'E-posta veya şifre hatalı.';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = 'Bu e-posta ile kayıtlı kullanıcı bulunamadı.';
                    } else {
                        errorMessage = error.message;
                    }
                    loginMessage.textContent = errorMessage;
                    loginMessage.style.color = 'red';
                    console.error('Giriş hatası:', error);
                }
            });

            // Şifre Sıfırlama
            performResetBtn.addEventListener('click', async () => {
                const email = resetEmailInput.value.trim();
                if (!email) {
                    resetMessage.textContent = 'Lütfen e-posta adresinizi girin.';
                    resetMessage.style.color = 'red';
                    return;
                }

                try {
                    await auth.sendPasswordResetEmail(email);
                    resetMessage.textContent = 'Şifre sıfırlama linki e-posta adresinize gönderildi.';
                    resetMessage.style.color = 'green';
                    setTimeout(() => hideModal(forgotPasswordModal), 3000);
                } catch (error) {
                    let errorMessage = 'Şifre sıfırlama isteği gönderilirken bir hata oluştu.';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'Bu e-posta ile kayıtlı kullanıcı bulunamadı.';
                    } else {
                        errorMessage = error.message;
                    }
                    resetMessage.textContent = errorMessage;
                    resetMessage.style.color = 'red';
                    console.error('Şifre sıfırlama hatası:', error);
                }
            });

            // Çıkış Yapma
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await auth.signOut();
                        window.showModal('Çıkış Başarılı', 'Başarıyla çıkış yaptınız.');
                    } catch (error) {
                        console.error('Çıkış yaparken hata:', error);
                        window.showModal('Hata', 'Çıkış yaparken bir hata oluştu: ' + error.message);
                    }
                });
            }

            // Tatil Avı (Oyun)
            startGameBtn.onclick = () => {
                gameActive = true;
                currentQuestionIndex = 0;
                gameScore = 0;
                if (currentUserId) {
                    window.updateUserProfile({ gameScore: gameScore });
                }
                gameOutput.innerHTML = `<p><strong>Palmiye Kaptan:</strong> Tatil Avı oyununa hoş geldin! Sana 3 soru soracağım. Doğru cevap verirsen PalmCoin kazanacaksın!</p>`;
                gameAnswerInput.style.display = "block";
                submitGameAnswerBtn.style.display = "block";
                startGameBtn.style.display = "none";
                window.speak("Tatil Avı oyununa hoş geldin! Sana üç soru soracağım. Doğru cevap verirsen PalmCoin kazanacaksın!");
                setTimeout(askNextGameQuestion, 2000);
            };

            submitGameAnswerBtn.onclick = () => handleGameAnswer(gameAnswerInput.value);
            gameAnswerInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") submitGameAnswerBtn.click();
            });

            async function askNextGameQuestion() {
                if (currentQuestionIndex < 3) {
                    gameOutput.innerHTML += `<p><i class="fas fa-spinner fa-spin"></i> Palmiye Kaptan yeni soru hazırlıyor...</p>`;
                    gameAnswerInput.value = "";
                    gameAnswerInput.focus();
                    try {
                        const aiResponse = await window.callOpenRouterAI(
                            `Create a short trivia question about travel, geography, or culture with 3 multiple-choice options (A, B, C) and a single correct answer.
                            Format the response as 'Soru: [Question Text] Seçenekler: (A) [Option A] (B) [Option B] (C) [Option C] Cevap: [Correct Option Letter (e.g.: A)]'.
                            Ensure options are clearly labeled (A), (B), (C). Provide in Turkish.`,
                            "openai/gpt-3.5-turbo",
                            null
                        );

                        const questionMatch = aiResponse.match(/Soru:\s*(.*?)\s*Seçenekler:\s*(.*?)\s*Cevap:\s*([A-C])/i);
                        if (questionMatch && questionMatch.length === 4) {
                            const questionText = questionMatch[1].trim();
                            const optionsText = questionMatch[2].trim();
                            const correctAnswer = questionMatch[3].trim().toUpperCase();

                            const optionsArray = [];
                            const optionRegex = /\(([A-C])\)\s*([^)(]+)/g;
                            let match;
                            while ((match = optionRegex.exec(optionsText)) !== null) {
                                optionsArray.push(`(${match[1].toUpperCase()}) ${match[2].trim()}`);
                            }
                            if (optionsArray.length === 0 && optionsText) {
                                const rawOptions = optionsText.split(/ \(B\) | \(C\) /).map(s => s.trim());
                                if (rawOptions[0]) optionsArray.push(`(A) ${rawOptions[0].replace('(A) ', '')}`);
                                if (rawOptions[1]) optionsArray.push(`(B) ${rawOptions[1].replace('(B) ', '')}`);
                                if (rawOptions[2]) optionsArray.push(`(C) ${rawOptions[2].replace('(C) ', '')}`);
                            }

                            currentGameQuestion = {
                                question: questionText,
                                options: optionsArray.length > 0 ? optionsArray : [optionsText],
                                answer: correctAnswer,
                                points: 20 + (currentQuestionIndex * 5)
                            };

                            gameOutput.innerHTML += `<p><strong>Palmiye Kaptan:</strong> Soru ${currentQuestionIndex + 1}: ${currentGameQuestion.question}<br>${currentGameQuestion.options.join("<br>")}</p>`;
                            window.speak(`Soru ${currentQuestionIndex + 1}: ${currentGameQuestion.question} ${currentGameQuestion.options.join(" ")}`);
                        } else {
                            gameOutput.innerHTML += `<p style="color: red;"><strong>Palmiye Kaptan:</strong> Bir sorun oluştu, soru oluşturulamadı. Lütfen tekrar deneyin. Detay: ${aiResponse}</p>`;
                            window.speak("Bir sorun oluştu, soru oluşturulamadı.");
                            endGame();
                        }
                    } catch (error) {
                        console.error("Oyun sorusu oluşturulurken hata:", error);
                        gameOutput.innerHTML += `<p style="color: red;"><strong>Palmiye Kaptan:</strong> Soru oluşturulurken bir hata oluştu: ${error.message}.</p>`;
                        window.speak("Soru oluşturulurken bir hata oluştu.");
                        endGame();
                    }
                } else {
                    endGame();
                }
            }

            async function handleGameAnswer(answer) {
                if (!currentGameQuestion) {
                    gameOutput.innerHTML += `<p style="color: red;"><strong>Palmiye Kaptan:</strong> Henüz bir soru yok. Lütfen oyunu başlatın.</p>`;
                    return;
                }

                const userAnswer = answer.trim().toUpperCase();
                gameAnswerInput.value = "";

                if (userAnswer === currentGameQuestion.answer) {
                    gameOutput.innerHTML += `<p style="color: green;"><strong>Palmiye Kaptan:</strong> Tebrikler! Doğru cevap. (+${currentGameQuestion.points} PalmCoin)</p>`;
                    window.speak("Tebrikler! Doğru cevap.");
                    gameScore += currentGameQuestion.points;
                    if (currentUserId) {
                        await window.updateUserProfile({ gameScore: gameScore });
                    }
                    window.updateTatilPuan(currentGameQuestion.points, `Tatil Avı Oyunu (Soru ${currentQuestionIndex + 1})`);
                } else {
                    gameOutput.innerHTML += `<p style="color: red;"><strong>Palmiye Kaptan:</strong> Yanlış cevap. Doğru cevap: ${currentGameQuestion.answer}</p>`;
                    window.speak(`Yanlış cevap. Doğru cevap ${currentGameQuestion.answer}`);
                }

                currentQuestionIndex++;
                if (currentQuestionIndex < 3) {
                    setTimeout(askNextGameQuestion, 1500);
                } else {
                    setTimeout(endGame, 1500);
                }
            }

            function endGame() {
                gameActive = false;
                gameOutput.innerHTML += `<p><strong>Palmiye Kaptan:</strong> Oyun bitti! Toplam **${gameScore} PalmCoin** kazandın! TatilPuan'ın güncellendi.</p>`;
                window.speak(`Oyun bitti! Toplam ${gameScore} PalmCoin kazandın!`);
                gameAnswerInput.style.display = "none";
                submitGameAnswerBtn.style.display = "none";
                startGameBtn.style.display = "block";
                window.displayMembershipInfo();
            }

            virtualDurationMinutesInput.addEventListener("input", () => {
                const minutes = parseInt(virtualDurationMinutesInput.value) || 0;
                virtualTourCostEl.textContent = (minutes * VIRTUAL_TOUR_COST_PER_MINUTE);
            });

            startVirtualBtn.onclick = async () => {
                const city = virtualCityInput.value.trim();
                const days = parseInt(virtualDaysInput.value);
                const minutes = parseInt(virtualDurationMinutesInput.value);
                const activities = virtualActivitiesInput.value.trim();
                const imagePrompt = virtualImagePromptInput.value.trim();

                if (!city || isNaN(days) || days < 1 || isNaN(minutes) || minutes < 1 || !imagePrompt || !activities) {
                    window.showModal("Eksik Bilgi", "Lütfen tüm sanal tatil alanlarını (Şehir, Gün Sayısı, Sanal Tur Süresi, Yapmak İstedikleriniz, Hediye Resim Açıklaması) eksiksiz doldurun.");
                    return;
                }

                const totalCost = (minutes * VIRTUAL_TOUR_COST_PER_MINUTE);
                if (tatilPuan < totalCost) {
                    window.showModal("Yetersiz PalmCoin", `Sanal tur için ${totalCost} PalmCoin'e ihtiyacınız var. Mevcut PalmCoin: ${tatilPuan}. Daha fazla PalmCoin kazanmak için oyun oynayabilir veya VIP üyeliğinizi kontrol edebilirsiniz.`);
                    return;
                }

                virtualHolidayOutput.style.display = "none";
                virtualImagesContainer.innerHTML = '';
                sendVirtualImageEmailBtn.style.display = 'none';
                generatedVirtualImageUrl = '';

                await window.updateTatilPuan(-totalCost, `Sanal Tatil Oluşturma (${city}, ${days} gün)`);
                window.showModal("Ödeme Alındı", `${totalCost} PalmCoin bakiyenizden düşüldü. Sanal tatiliniz hazırlanıyor...`);

                const storyPrompt = `Please write a ${days}-day virtual holiday story for ${city}, lasting ${minutes} minutes.
                                    The holiday should include activities like: ${activities}. Describe the places to visit, tastes to try, and experiences to live in detail.
                                    The story should be engaging, immersive, and creative.
                                    Create a separate paragraph for each day. At the end of each paragraph, add a short and descriptive image prompt for an image related to that day in the format "(GÖRSEL-PROMPT: [Image Description])".
                                    Make sure to include at least ${days} image prompts.
                                    General gift image prompt: "${imagePrompt}". You can use this as a theme throughout the story.
                                    Provide the response in Turkish.`;

                const reply = await window.callOpenRouterAI(storyPrompt, "openai/gpt-3.5-turbo", virtualLoading);
                virtualOutputTitle.textContent = `${city} - ${days} Günlük Sanal Tatil Hikayen:`;
                virtualOutputStory.innerHTML = '';
                const paragraphs = reply.split('\n').filter(p => p.trim() !== '');

                const imagePromptsForDays = [];
                let fullStoryHtml = '';
                let hasDailyImagePrompts = false;

                for (const p of paragraphs) {
                    const dailyImageMatch = p.match(/\(GÖRSEL-PROMPT:\s*([^)]+)\)/);
                    if (dailyImageMatch && dailyImageMatch[1]) {
                        imagePromptsForDays.push(dailyImageMatch[1].trim());
                        fullStoryHtml += `<p>${p.replace(dailyImageMatch[0], '').trim()}</p>`;
                        hasDailyImagePrompts = true;
                    } else {
                        fullStoryHtml += `<p>${p}</p>`;
                    }
                }
                virtualOutputStory.innerHTML = fullStoryHtml;
                virtualHolidayOutput.style.display = "block";

                generatedVirtualImageUrl = await window.callImageGenerationAI(imagePrompt, virtualLoading);
                if (generatedVirtualImageUrl) {
                    const giftImageEl = document.createElement('img');
                    giftImageEl.src = generatedVirtualImageUrl;
                    giftImageEl.alt = imagePrompt;
                    giftImageEl.style.cssText = 'max-width: 100%; height: auto; border-radius: 8px; margin-top: 15px; display: block; border: 2px solid #004d40;';
                    const giftImageCaption = document.createElement('p');
                    giftImageCaption.textContent = " 🎁  Sanal Tatil Hediye Görseliniz:";
                    giftImageCaption.style.cssText = 'font-weight: bold; margin-top: 15px; color: #004d40; text-align: center;';
                    virtualImagesContainer.appendChild(giftImageCaption);
                    virtualImagesContainer.appendChild(giftImageEl);
                    sendVirtualImageEmailBtn.style.display = 'block';
                }

                if (hasDailyImagePrompts) {
                    window.showModal("Görseller Oluşturuluyor", `Sanal tatiliniz için ${imagePromptsForDays.length} adet özel görsel hazırlanıyor...`);
                    for (let i = 0; i < imagePromptsForDays.length; i++) {
                        const dailyPrompt = imagePromptsForDays[i];
                        const dailyImageUrl = await window.callImageGenerationAI(dailyPrompt, virtualLoading);
                        if (dailyImageUrl) {
                            const dailyImageEl = document.createElement('img');
                            dailyImageEl.src = dailyImageUrl;
                            dailyImageEl.alt = `Gün ${i + 1} için görsel: ${dailyPrompt}`;
                            dailyImageEl.style.cssText = 'width: calc(50% - 15px); height: 180px; object-fit: cover; border-radius: 8px; border: 1px solid #00796b;';
                            const dailyImageCaption = document.createElement('p');
                            dailyImageCaption.textContent = `Gün ${i + 1} Görseli: ${dailyPrompt}`;
                            dailyImageCaption.style.cssText = 'font-size: 0.9em; color: #555; text-align: center; width: 100%;';
                            const imageWrapper = document.createElement('div');
                            imageWrapper.style.cssText = 'display: flex; flex-direction: column; align-items: center; width: calc(50% - 15px); margin-bottom: 10px;';
                            imageWrapper.appendChild(dailyImageEl);
                            imageWrapper.appendChild(dailyImageCaption);
                            virtualImagesContainer.appendChild(imageWrapper);
                        }
                    }
                    window.speak("Sanal tatiliniz ve tüm görselleriniz hazır!");
                } else if (generatedVirtualImageUrl) {
                    window.speak("Sanal tatiliniz ve hediye resminiz hazır!");
                } else {
                    window.speak("Sanal tatiliniz hazır, ancak resimler oluşturulamadı.");
                }
                window.updateTatilPuan(10, "Sanal Tatil Başarılı");
            };

            sendVirtualImageEmailBtn.onclick = async () => {
                if (!generatedVirtualImageUrl) {
                    window.showModal("Hata", "Önce bir sanal tatil resmi oluşturmalısınız.");
                    return;
                }

                let emailToSendTo = userEmail;
                if (emailToSendTo === "Ayarlanmadı" || !emailToSendTo) {
                    const newEmail = prompt("Hediye resmi göndermek için lütfen e-posta adresinizi girin:");
                    if (newEmail && newEmail.trim() !== "") {
                        emailToSendTo = newEmail.trim();
                        if (currentUserId) {
                            await window.updateUserProfile({ email: emailToSendTo });
                        }
                        window.displayMembershipInfo();
                    } else {
                        window.showModal("İptal Edildi", "E-posta adresi girilmediği için işlem iptal edildi.");
                        return;
                    }
                }
                try {
                    const sendWelcomeEmailCallable = firebase.functions().httpsCallable('sendWelcomeEmail');
                    await sendWelcomeEmailCallable({ email: emailToSendTo, username: userName || "Değerli Kullanıcımız", imageUrl: generatedVirtualImageUrl, subject: "Sanal Tatil Hediye Resminiz!" });
                    window.showModal("E-posta Gönderiliyor", `Hediye resminiz ${emailToSendTo} adresine gönderildi.`);
                    window.speak("Hediye resminiz e-postanıza gönderildi.");
                } catch (e) {
                    console.error("Hediye resmini gönderirken Cloud Function hatası:", e);
                    window.showModal("Hata", `Hediye resmi gönderilirken bir hata oluştu: ${e.message}`);
                }
            };

            // AI Fotoğraf Stüdyosu Logic
            goToAiPhotoPaymentBtn.onclick = () => window.showSection("payment-section");

            generateAiPhotoButton.onclick = async () => {
                const promptText = aiPhotoPromptInput.value.trim();
                const style = aiPhotoStyleSelect.value;
                const count = parseInt(aiPhotoCountInput.value);

                if (!promptText) {
                    window.showModal("Eksik Bilgi", "Lütfen oluşturmak istediğiniz fotoğrafı tanımlayın.");
                    return;
                }
                if (isNaN(count) || count < 1 || count > 3) {
                    window.showModal("Hata", "Lütfen 1 ile 3 arasında geçerli bir resim sayısı girin.");
                    return;
                }
                if (userMembershipLevel !== "Altın") {
                    window.showModal("Erişim Reddedildi", "Bu özellik sadece Altın üyelere özeldir. Lütfen üyeliğinizi yükseltin.");
                    return;
                }

                generatedImagesContainer.innerHTML = '';
                downloadAllImagesBtn.style.display = 'none';
                aiPhotoOutput.style.display = 'none';
                currentGeneratedImages = [];

                const totalDownloadCost = count * IMAGE_DOWNLOAD_COST_PER_IMAGE;
                downloadAllCostSpan.textContent = totalDownloadCost;

                aiPhotoOutput.style.display = 'block';
                window.showModal("Görsel Oluşturuluyor", `Yapay zeka fotoğrafınız (${count} adet) oluşturuluyor...`);

                for (let i = 0; i < count; i++) {
                    const combinedPrompt = `${promptText}, style: ${style}`;
                    const imageUrl = await window.callImageGenerationAI(combinedPrompt, aiPhotoLoading);
                    if (imageUrl) {
                        currentGeneratedImages.push(imageUrl);
                        const imgElement = document.createElement('img');
                        imgElement.src = imageUrl;
                        imgElement.alt = `AI Photo ${i + 1}: ${promptText}`;
                        imgElement.style.cssText = 'width: calc(50% - 15px); height: 180px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);';
                        generatedImagesContainer.appendChild(imgElement);
                    }
                }

                if (currentGeneratedImages.length > 0) {
                    downloadAllImagesBtn.style.display = 'block';
                    window.speak("Fotoğraflarınız başarıyla oluşturuldu!");
                } else {
                    window.showModal("Hata", "Hiç fotoğraf oluşturulamadı. Lütfen prompt'u kontrol edin.");
                    window.speak("Hiç fotoğraf oluşturulamadı.");
                }
            };

            downloadAllImagesBtn.onclick = async () => {
                if (currentGeneratedImages.length === 0) {
                    window.showModal("Hata", "Önce fotoğraf oluşturmalısınız.");
                    return;
                }

                const totalCost = currentGeneratedImages.length * IMAGE_DOWNLOAD_COST_PER_IMAGE;
                if (tatilPuan < totalCost) {
                    window.showModal("Yetersiz PalmCoin", `Tüm fotoğrafları indirmek için ${totalCost} PalmCoin'e ihtiyacınız var. Mevcut PalmCoin: ${tatilPuan}.`);
                    return;
                }

                await window.updateTatilPuan(-totalCost, `AI Fotoğraf İndirme (${currentGeneratedImages.length} adet)`);
                window.showModal("İndiriliyor!", `Tüm ${currentGeneratedImages.length} fotoğrafınız indiriliyor. PalmCoin bakiyeniz güncellendi.`);
                window.speak("Fotoğraflarınız indiriliyor.");

                for (let i = 0; i < currentGeneratedImages.length; i++) {
                    const imageUrl = currentGeneratedImages[i];
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = `palmiye-kaptan-ai-foto-${Date.now()}-${i + 1}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                currentGeneratedImages = [];
                generatedImagesContainer.innerHTML = '';
                downloadAllImagesBtn.style.display = 'none';
                aiPhotoOutput.style.display = 'none';
            };

            // VIP Planlayıcı Logic
            goToVipPaymentBtn.onclick = () => window.showSection("payment-section");

            vipBudgetButtons.forEach(button => {
                button.onclick = () => {
                    vipBudgetButtons.forEach(btn => btn.classList.remove("selected"));
                    button.classList.add("selected");
                    selectedBudget = button.dataset.budget;
                };
            });

            generateVipPlanBtn.onclick = async () => {
                const destination = vipDestinationInput.value.trim();
                const duration = parseInt(vipDurationInput.value);
                const travelers = parseInt(vipTravelersInput.value);
                const travelType = vipTypeSelect.value;

                if (!destination || isNaN(duration) || duration < 1 || isNaN(travelers) || travelers < 1 || !selectedBudget) {
                    window.showModal("Eksik Bilgi", "Lütfen tüm alanları doldurun ve bütçe seçimi yapın.");
                    return;
                }
                if (userMembershipLevel !== "Altın") {
                    window.showModal("Erişim Reddedildi", "Bu özellik sadece Altın üyelere özeldir. Lütfen üyeliğinizi yükseltin.");
                    return;
                }

                vipPlanOutput.style.display = "none";
                vipPlanChatArea.style.display = "none";
                vipPlanChatBox.innerHTML = '';
                currentVipPlan = "";

                const prompt = `Please create a very detailed, comprehensive, and personalized A-to-Z holiday plan for ${destination} for ${duration} days, for ${travelers} people, with a ${selectedBudget} budget, and a ${travelType} theme.
                                Include flight suggestions (example airline and approximate price range), hotel suggestions (example hotel name, price range, proximity to location, and features), airport transfer suggestions (how to do it, approximate cost), daily detailed places to visit/activities/food suggestions (specific places and tastes for morning, noon, and evening).
                                All suggestions should be suitable for this budget. Provide example links (like Booking.com, Skyscanner, TripAdvisor, a random Unsplash image link).
                                Provide the response in Turkish. Enrich the details, include small details, not just main outlines.`;

                const reply = await window.callOpenRouterAI(prompt, "openai/gpt-3.5-turbo", vipPlannerLoading);
                currentVipPlan = reply;
                let planContent = reply;

                const urlRegex = /(https?:\/\/[^\s]+\.(?:png|jpe?g|gif|webp|unsplash\.com\/\S+|pixabay\.com\/\S+))/i;
                const match = planContent.match(urlRegex);
                let mediaHtml = "";
                if (match) {
                    mediaHtml = `<br><img src="${match[0]}" alt="${destination} Planı">`;
                    planContent = planContent.replace(match[0], '').trim();
                } else {
                    const genericImageUrl = await window.callImageGenerationAI(`${destination} travel`, null);
                    mediaHtml = `<br><img src="${genericImageUrl}" alt="${destination} Planı">`;
                }

                vipPlanOutput.innerHTML = `<h4>${destination} için ${duration} Günlük VIP Tatil Planınız:</h4><p>${planContent.replace(/\n/g, '<br>')}</p>${mediaHtml}`;
                vipPlanOutput.style.display = "block";
                vipPlanChatArea.style.display = "block";
                window.speak(`${destination} için VIP tatil planınız hazır.`);
                await window.updateTatilPuan(100, `VIP Plan Oluşturma (${destination})`);
            };

            // VIP Plan hakkında soru sorma
            sendVipPlanMessageBtn.onclick = async () => {
                const userQuestion = vipPlanInput.value.trim();
                if (!userQuestion) return;

                if (tatilPuan < VIP_PLAN_CHAT_COST) {
                    window.showModal("Yetersiz PalmCoin", `Bu soru için ${VIP_PLAN_CHAT_COST} PalmCoin'e ihtiyacınız var. Mevcut PalmCoin: ${tatilPuan}.`);
                    return;
                }

                window.displayMessage("user", userQuestion, vipPlanChatBox);
                vipPlanInput.value = "";

                await window.updateTatilPuan(-VIP_PLAN_CHAT_COST, "VIP Plan Detay Sorgusu");

                const prompt = `User's previously generated VIP travel plan (with all details): "${currentVipPlan}".
                                User's new question about this plan: "${userQuestion}".
                                Based on this plan and question, provide an informative and detailed response.
                                Elaborate only on the relevant part and do not repeat the entire plan.
                                Provide the response in Turkish.`;

                const reply = await window.callOpenRouterAI(prompt, "openai/gpt-3.5-turbo", vipPlannerLoading);
                window.displayMessage("ai", reply, vipPlanChatBox);
                vipPlanChatBox.scrollTop = vipPlanChatBox.scrollHeight;
                window.speak(reply);
            };

            vipPlanInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendVipPlanMessageBtn.click();
            });

            // Niş Tur Planı Logic
            generateNichePlanBtn.onclick = async () => {
                const nicheTopic = nicheTopicInput.value.trim();
                const nicheDetails = nicheDetailsTextarea.value.trim();

                if (!nicheTopic || !nicheDetails) {
                    window.showModal("Eksik Bilgi", "Lütfen niş konuyu ve özel isteklerinizi detaylıca girin.");
                    return;
                }
                if (userMembershipLevel !== "Altın") {
                    window.showModal("Erişim Reddedildi", "Bu özellik sadece Altın üyelere özeldir. Lütfen üyeliğinizi yükseltin.");
                    return;
                }

                nichePlanOutput.style.display = "none";

                const prompt = `User's niche travel topic: "${nicheTopic}". Special requests: "${nicheDetails}".
                                Based on this information, plan the user's dream niche tour in a very detailed, unusual, creative, and truly bespoke service manner.
                                Suggest possible destinations, unique activities, special accommodation options, and experiences suitable for the niche topic.
                                Present the plan in a friendly and inspiring tone, in Turkish.
                                If appropriate, suggest an image link relevant to that niche topic (e.g., Unsplash link).`;

                const reply = await window.callOpenRouterAI(prompt, "openai/gpt-3.5-turbo", nichePlanLoading);
                let nichePlanContent = reply;
                const urlRegex = /(https?:\/\/[^\s]+\.(?:png|jpe?g|gif|webp|unsplash\.com\/\S+|pixabay\.com\/\S+))/i;
                const match = nichePlanContent.match(urlRegex);
                let mediaHtml = "";
                if (match) {
                    mediaHtml = `<br><img src="${match[0]}" alt="${nicheTopic} Niş Planı">`;
                    nichePlanContent = nichePlanContent.replace(match[0], '').trim();
                } else {
                    const genericImageUrl = await window.callImageGenerationAI(`${nicheTopic} travel`, null);
                    mediaHtml = `<br><img src="${genericImageUrl}" alt="${nicheTopic} Niş Planı">`;
                }

                nichePlanOutput.innerHTML = `<h4>Özel Niş Tur Planınız - "${nicheTopic}":</h4><p>${nichePlanContent.replace(/\n/g, '<br>')}</p>${mediaHtml}`;
                nichePlanOutput.style.display = "block";
                window.speak(`Niş tur planınız hazır!`);
                await window.updateTatilPuan(150, `Niş Plan Oluşturma (${nicheTopic})`);
            };

            // Kullanıcı adı güncelleme butonu
            updateUsernameBtn.onclick = async () => {
                const newName = prompt("Lütfen yeni kullanıcı adınızı girin:");
                if (newName && newName.trim() !== "") {
                    userName = newName.trim();
                    if (currentUserId) {
                        await auth.currentUser.updateProfile({ displayName: userName });
                        await window.updateUserProfile({ username: userName });
                    }
                    window.showModal("Hoş Geldin!", `Hoş geldin, **${userName}**! Kullanıcı adınız güncellendi.`);
                    window.speak(`Hoş geldin ${userName}!`);
                    window.displayMembershipInfo();
                } else {
                    window.showModal("Bilgi", "Ad girilmediği için mevcut adınız değişmedi.");
                }
            };

            // E-posta ayarlama/güncelleme butonu
            setuserEmailBtn.onclick = async () => {
                const newEmail = prompt("Lütfen e-posta adresinizi girin:");
                if (newEmail && newEmail.trim() !== "") {
                    userEmail = newEmail.trim();
                    if (currentUserId) {
                        await window.updateUserProfile({ email: userEmail });
                    }
                    window.showModal("E-posta Güncellendi", `E-posta adresiniz **${userEmail}** olarak güncellendi.`);
                    window.speak(`E-posta adresiniz ${userEmail} olarak güncellendi.`);
                    window.displayMembershipInfo();
                } else {
                    window.showModal("Bilgi", "E-posta girilmediği için mevcut e-posta değişmedi.");
                }
            };

            // Yönetici Mesajı Güncelleme Logic
            updateAdminMessageBtn.onclick = async () => {
                const message = adminMessageInput.value.trim();
                if (!message) {
                    window.showModal("Uyarı", "Lütfen yayınlamak istediğiniz mesajı girin.");
                    return;
                }
                await window.updateAdminMessage(message);
            };

            // Zamanda Yolculuk Tatili Logic
            goToTimeTravelPaymentBtn.onclick = () => window.showSection("payment-section");

            startTimeTravelBtn.onclick = async () => {
                const era = timeTravelEraInput.value.trim();
                const duration = parseInt(timeTravelDurationInput.value);
                const character = timeTravelCharacterInput.value.trim();
                const focus = timeTravelFocusInput.value.trim();

                if (!era || isNaN(duration) || duration < 1) {
                    window.showModal("Eksik Bilgi", "Lütfen geçerli bir dönem ve gün sayısı girin.");
                    return;
                }
                if (userMembershipLevel !== "Altın") {
                    window.showModal("Erişim Reddedildi", "Bu özellik sadece Altın üyelere özeldir. Lütfen üyeliğinizi yükseltin.");
                    return;
                }

                timeTravelOutput.style.display = "none";

                const prompt = `Please create a ${duration}-day time travel holiday story set in the "${era}" period.
                                Describe the atmosphere, important events, clothing, food, and potential interactions of that era in a detailed, immersive, and imaginative way.
                                ${character ? `In this journey, specifically include an opportunity to meet or interact with "${character}".` : ''}
                                ${focus ? `The theme "${focus}" should be prominent as a focal point.` : ''}
                                The story should be engaging and include an image link relevant to that period (e.g., an Unsplash or Pixabay link).
                                Provide the response in Turkish. Focus on details.`;

                const reply = await window.callOpenRouterAI(prompt, "openai/gpt-3.5-turbo", timeTravelLoading);
                let storyContent = reply;

                const urlRegex = /(https?:\/\/[^\s]+\.(?:png|jpe?g|gif|webp|unsplash\.com\/\S+|pixabay\.com\/\S+))/i;
                const match = storyContent.match(urlRegex);
                let mediaHtml = "";
                if (match) {
                    mediaHtml = `<br><img src="${match[0]}" alt="${era} Dönemi">`;
                    storyContent = storyContent.replace(match[0], '').trim();
                } else {
                    const genericImageUrl = await window.callImageGenerationAI(`${era} travel`, null);
                    mediaHtml = `<br><img src="${genericImageUrl}" alt="${era} Dönemi">`;
                }

                timeTravelOutput.innerHTML = `<h4>${era} Döneminde Zaman Yolculuğu Tatiliniz:</h4><p>${storyContent.replace(/\n/g, '<br>')}</p>${mediaHtml}`;
                timeTravelOutput.style.display = "block";
                window.speak(`${era} dönemine yolculuk hikayeniz hazır.`);
                await window.updateTatilPuan(75, `Zamanda Yolculuk (${era})`);
            };

            // Kader Rotası Logic
            predictDestinyBtn.onclick = async () => {
                const age = destinyAgeInput.value.trim();
                const hobby = destinyHobbyInput.value.trim();
                const destinyDream = destinyDreamInput.value.trim();
                const destinyColor = destinyColorInput.value.trim();

                if (!age || !hobby || !destinyDream) {
                    window.showModal("Eksik Bilgi", "Lütfen yaşınızı, hobinizi ve hayalinizi girin.");
                    return;
                }

                destinyRouteOutput.style.display = "none";
                realizeDestinyBtn.style.display = "none";

                const prompt = `Based on the following user information, predict their future "destiny holiday" or "dream vacation" in an absurd, fun, and imaginative way.
                                This prediction should be like a prophecy. For example, start with "According to Palmiye Kaptan's crystal ball, in 20XX..."
                                The prediction can include a destination, a hypothetical event specific to that year, and even characters (generated by AI) they might meet there.
                                User information: Age: ${age}, Hobby: ${hobby}, Dream: ${destinyDream}. ${destinyColor ? `Favorite color: ${destinyColor}.` : ''}
                                Subtly incorporate this color into the atmosphere or locations of the prophecy.
                                Provide the response in Turkish and include an encouraging, attractive message for VIP membership (e.g., "Making this destiny a reality is exclusive to Gold Members!").
                                Be more creative and humorous. Add a visual imaginative description related to the prophecy in the format "(GÖRSEL: [image description])".`;

                const reply = await window.callOpenRouterAI(prompt, "openai/gpt-3.5-turbo", destinyLoading);
                let destinyContent = reply;
                const imageMatch = destinyContent.match(/\(GÖRSEL:\s*([^)]+)\)/);
                let destinyMediaHtml = "";
                let destinyImagePrompt = "";
                if (imageMatch && imageMatch[1]) {
                    destinyImagePrompt = imageMatch[1].trim();
                    destinyContent = destinyContent.replace(imageMatch[0], '').trim();
                }

                destinyRouteOutput.innerHTML = `<h4>Kader Rotanızın Kehaneti:</h4><p>${destinyContent.replace(/\n/g, '<br>')}</p>`;

                if (destinyImagePrompt) {
                    const imageUrl = await window.callImageGenerationAI(destinyImagePrompt, destinyLoading);
                    if (imageUrl) {
                        destinyMediaHtml = `<br><img src="${imageUrl}" alt="Kader Rotası Görseli" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">`;
                        destinyRouteOutput.innerHTML += destinyMediaHtml;
                    }
                }

                destinyRouteOutput.style.display = "block";
                window.speak("Kader rotanız hazırlandı!");
                realizeDestinyBtn.style.display = "block";
                await window.updateTatilPuan(40, "Kader Rotası Kehaneti");
            };

            realizeDestinyBtn.onclick = () => {
                if (userMembershipLevel === "Altın") {
                    window.showModal("Kader Gerçekleşiyor!", "Harika! Altın üye olarak kader rotanızı gerçeğe dönüştürme zamanı. VIP Tur Planlayıcıya yönlendiriliyorsunuz.");
                    window.showSection("vip-planner-section");
                } else {
                    window.showModal("Erişim Reddedildi", "Kader rotanızı gerçeğe dönüştürmek Altın üyelere özeldir. Lütfen üyeliğinizi yükseltin!");
                    window.showSection("payment-section");
                }
            };

            // AI Yoldaşım Logic
            createCompanionBtn.onclick = async () => {
                const companionName = companionNameInput.value.trim();
                const personality = companionPersonalitySelect.value;

                if (!companionName) {
                    window.showModal("Eksik Bilgi", "Lütfen yoldaşınıza bir isim verin.");
                    return;
                }

                companionChatArea.style.display = "none";
                companionChatBox.innerHTML = '';
                companionChatHistory = [];

                const prompt = `Please create an AI companion character named "${companionName}" with a "${personality}" personality, specializing in travel.
                                Write a short, friendly introductory text for them and make their first greeting. Provide the response in Turkish. Be creative.`;

                const reply = await window.callOpenRouterAI(prompt, "openai/gpt-3.5-turbo", companionLoading);
                aiCompanion = { name: companionName, personality: personality, intro: reply };

                activeCompanionName.textContent = companionName;
                window.displayMessage("ai", aiCompanion.intro, companionChatBox);
                companionChatHistory.push({ role: "assistant", content: aiCompanion.intro });
                companionChatArea.style.display = "block";
                window.speak(`${companionName} adında, ${personality} kişiliğe sahip yoldaşınız oluşturuldu.`);
                await window.updateTatilPuan(30, `AI Yoldaş Oluşturma (${companionName})`);
            };

            sendCompanionMessageBtn.onclick = async () => {
                const userMessage = companionInput.value.trim();
                if (!userMessage) return;

                window.displayMessage("user", userMessage, companionChatBox);
                companionChatHistory.push({ role: "user", content: userMessage });
                companionInput.value = "";

                if (!aiCompanion) {
                    window.showModal("Hata", "Önce bir AI Yoldaşı oluşturmalısın!");
                    return;
                }

                const maxHistoryLength = 5;
                const recentHistory = companionChatHistory.slice(Math.max(0, companionChatHistory.length - maxHistoryLength));

                const systemMessage = {
                    role: "system",
                    content: `Your name is ${aiCompanion.name} and your personality is ${aiCompanion.personality}. The user's name is ${userName}.
                                Help the user with travel and holiday topics. Provide creative, friendly, and conversational responses in line with your personality.
                                Maintain context by considering the user's previous messages.`
                };
                const messagesToSend = [systemMessage, ...recentHistory];

                const reply = await window.callOpenRouterAI(null, "openai/gpt-3.5-turbo", companionLoading, messagesToSend);

                window.displayMessage("ai", reply, companionChatBox);
                companionChatHistory.push({ role: "assistant", content: reply });
                companionChatBox.scrollTop = companionChatBox.scrollHeight;
                window.speak(reply);
            };

            companionInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendCompanionMessageBtn.click();
            });

            // VIP Üyelik Ödeme Logic
            completePaymentBtn.onclick = async () => {
                const cardNumber = cardNumberInput.value.trim();
                const expiryDate = expiryDateInput.value.trim();
                const cvv = cvvInput.value.trim();
                const cardHolderName = cardHolderNameInput.value.trim();

                if (!cardNumber || !expiryDate || !cvv || !cardHolderName) {
                    window.showModal("Hata", "Lütfen tüm kart bilgilerini doldurun.");
                    return;
                }

                if (cardNumber.replace(/\s/g, '').length !== 16 || !/^\d{2}\/\d{2}$/.test(expiryDate) || !/^\d{3,4}$/.test(cvv)) {
                    window.showModal("Hata", "Lütfen geçerli kart bilgileri girin. (Demo için format önemi)");
                    return;
                }

                window.showModal("Ödeme İşleniyor...", "Ödemeniz simüle ediliyor. Lütfen bekleyin...");
                await new Promise(resolve => setTimeout(resolve, 2000));

                userMembershipLevel = "Altın";
                if (currentUserId) {
                    await window.updateUserProfile({ membershipLevel: userMembershipLevel });
                }
                await window.updateTatilPuan(200, "Altın Üyelik Satın Alma");

                let discountMessage = "Tebrikler! Artık Altın Üyesiniz! Tüm VIP özelliklere erişiminiz var. Keyfini çıkarın!";
                if (tatilPuan > 150) {
                    const bonusPalmCoin = 100;
                    gameScore += bonusPalmCoin;
                    if (currentUserId) {
                        await window.updateUserProfile({ gameScore: gameScore });
                    }
                    await window.updateTatilPuan(bonusPalmCoin, "Altın Üyelik Bonusu");
                    discountMessage += `<br><br>Sadakatiniz için teşekkür ederiz! Yüksek TatilPuan'ınız sayesinde **${bonusPalmCoin} PalmCoin** hediye kazandınız!`;
                }

                window.showModal("Ödeme Başarılı!", discountMessage);
                window.speak("Ödemeniz başarılı. Artık Altın üyesiniz!");
                window.showSection("user-info-section");
            };

            // Bize Ulaşın Formu Gönderimi
            sendContactFormBtn.onclick = async () => {
                const subject = contactSubjectInput.value.trim();
                const email = contactEmailInput.value.trim();
                const message = contactMessageInput.value.trim();
                const file = contactFileInput.files[0];

                if (!subject || !email || !message) {
                    window.showModal("Eksik Bilgi", "Lütfen Konu, E-posta Adresi ve Mesaj alanlarını doldurun.");
                    return;
                }

                if (contactLoading) contactLoading.style.display = 'block';

                let fileData = null;
                let fileName = null;
                let fileType = null;

                if (file) {
                    fileName = file.name;
                    fileType = file.type;
                    fileData = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                }

                try {
                    const submitContactFormCallable = firebase.functions().httpsCallable('submitContactForm');
                    const result = await submitContactFormCallable({
                        subject: subject,
                        email: email,
                        message: message,
                        fileName: fileName,
                        fileType: fileType,
                        fileData: fileData
                    });

                    window.showModal("Mesajınız Gönderildi", result.data.message);
                    window.speak("Mesajınız başarıyla gönderildi.");
                } catch (e) {
                    console.error("İletişim formu gönderilirken Cloud Function hatası:", e);
                    window.showModal("Hata", `Mesajınız gönderilirken bir hata oluştu: ${e.message}`);
                } finally {
                    if (contactLoading) contactLoading.style.display = 'none';
                    contactSubjectInput.value = '';
                    contactEmailInput.value = userEmail !== "Ayarlanmadı" ? userEmail : '';
                    contactMessageInput.value = '';
                    contactFileInput.value = '';
                }
            };

            // --- Slogan Güncelleme ---
            setInterval(updateSlogan, 5000);

            // --- Footer Yılını Güncelle ---
            const currentYearElement = document.getElementById('currentYear');
            if (currentYearElement) {
                currentYearElement.textContent = new Date().getFullYear();
            }

            console.warn("UYARI: Bu tek dosya, prototipleme amaçlıdır ve üretim için uygun DEĞİLDİR. API anahtarlarınız Cloud Functions tarafına taşınmıştır ancak Cloud Functions güvenlik kurallarını ve Firebase Security Rules'ı doğru bir şekilde yapılandırdığınızdan emin olun.");
            console.warn("Firebase yapılandırma bilgilerinizi ve AI API anahtarlarınızı kendi bilgilerinizle değiştirmeyi unutmayın.");
            console.warn("Firebase güvenlik kurallarınızı (Firestore Security Rules) uygulamanızın gereksinimlerine göre ayarladığınızdan emin olun. Özellikle 'public' koleksiyonları için okuma/yazma izinlerini ve kullanıcı profilleri için kullanıcıların yalnızca kendi verilerine erişebildiğinden emin olun.");
        });
    </script>
</body>
</html>